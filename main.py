import os
import json
import base64
import logging
import asyncio
import threading
from datetime import datetime, timedelta

import pytz
from flask import Flask, request

from telegram import (
    Update,
    ReplyKeyboardMarkup,
    KeyboardButton,
    ReplyKeyboardRemove,
)
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

import gspread
from google.oauth2.service_account import Credentials


# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
PUBLIC_URL = os.getenv("PUBLIC_URL", "").rstrip("/")
GSHEET_ID = os.getenv("GSHEET_ID")
GOOGLE_SA_JSON_B64 = os.getenv("GOOGLE_SA_JSON_B64")

DEFAULT_TZ = "Asia/Almaty"

# step –∑–Ω–∞—á–µ–Ω–∏—è
WAIT_TZ = "WAIT_TZ"
WAIT_NOTIFY_TIME = "WAIT_NOTIFY_TIME"
WAIT_BIRTH = "WAIT_BIRTH"
READY = "READY"

# --- –ü–û–õ–ù–´–ï –û–ü–ò–°–ê–ù–ò–Ø –ò–ó –í–ê–®–ò–• –§–ê–ô–õ–û–í ---

DESC_LG = {
    "1": {"n": "–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞", "d": "–≠—Ç–æ –≤—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Ö–æ—á–µ—à—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –±–ª–∏–∂–∞–π—à–∏–µ 9 –ª–µ—Ç. –ò–º–µ–Ω–Ω–æ —Å–µ–π—á–∞—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–∞–º—ã–π –º–æ—â–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –∑–∞ –≤–µ—Å—å —Ü–∏–∫–ª.", "r": "–û—Ç–∫—Ä—ã–≤–∞–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–µ–ª–æ –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç. –†–∞–∑–≤–∏–≤–∞–π –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —É—á–∏—Å—å –±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ —Å–µ–±—è. –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π.", "m": "–ú–æ–∂–µ—Ç –æ—â—É—â–∞—Ç—å—Å—è –∂–∂–µ–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç–∏ —Å–µ—Ä–¥–µ—á–Ω–æ–π —á–∞–∫—Ä—ã, –¥–µ–ø—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —á—É–≤—Å—Ç–≤–æ –ø—É—Å—Ç–æ—Ç—ã –æ—Ç –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è."},
    "2": {"n": "–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏", "d": "–ü–µ—Ä–∏–æ–¥ —Å–≤—è–∑–∞–Ω —Å –ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å—é –∏ –ø–µ—Ä–µ–º–µ–Ω–∞–º–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö. –°—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏ –º–æ–≥—É—Ç —Ä–∞–∑—Ä—É—à–∞—Ç—å—Å—è ‚Äî –≤–∞–∂–Ω–æ –Ω–µ —Ü–µ–ø–ª—è—Ç—å—Å—è –∑–∞ –Ω–∏—Ö, –∞ –º—è–≥–∫–æ –æ—Ç–ø—É—Å–∫–∞—Ç—å.", "r": "–£—á–∏—Å—å —Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–µ —Å–≤—è–∑–∏ –∏ —Ä–∞–∑–≤–∏–≤–∞–π –Ω–∞–≤—ã–∫–∏ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –°–æ—Ö—Ä–∞–Ω—è–π –≥–∏–±–∫–æ—Å—Ç—å, ¬´–æ—Å—Ç–∞–≤–ª—è–π –¥–≤–µ—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏¬ª. –°–º–æ—Ç—Ä–∏ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ.", "m": "–í–æ–∑–º–æ–∂–Ω—ã –¥–µ–ø—Ä–µ—Å—Å–∏—è –∏ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞–∑—Ä—ã–≤–æ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–π."},
    "3": {"n": "–ì–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –∏ —É—Å–ø–µ—Ö–∞", "d": "–ü—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ. –í—Ä–µ–º—è —É—Å–ø–µ—Ö–∞ —á–µ—Ä–µ–∑ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏ –≤–µ–¥–µ–Ω–∏–µ —É—á–µ—Ç–∞. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è.", "r": "–î–µ–π—Å—Ç–≤—É–π —á–µ—Ä–µ–∑ —Ä–∞—Å—á–µ—Ç, –ø–ª–∞–Ω–∏—Ä—É–π —à–∞–≥–∏ –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä–µ–¥. –ò–∑–±–µ–≥–∞–π –Ω–µ–æ–ø—Ä–∞–≤–¥–∞–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞ –∏ –∞–∑–∞—Ä—Ç–∞.", "m": "–õ–µ–Ω—å, –∞–∑–∞—Ä—Ç, –∫–æ—Ä—ã—Å—Ç—å, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–∂–∏–≤–µ —á–µ—Ä–µ–∑ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã."},
    "4": {"n": "–ì–æ–¥ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π", "d": "–ì–æ–¥ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–µ–π —á–µ—Ä–µ–∑ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –í—Ä–µ–º—è –∫—Ä–µ–∞—Ç–∏–≤–∞ –∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ü–µ—Ä–∏–æ–¥ –ø–µ—Ä–µ–º–µ–Ω –∏ –Ω–æ–≤—ã—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–≤.", "r": "–°—Ç–∞–≤—å —á–µ—Ç–∫–∏–µ —Ü–µ–ª–∏, –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º, —Ç—Ä—É–¥–∏—Å—å —á–µ—Å—Ç–Ω–æ. –ò–∑–±–µ–≥–∞–π –∏–ª–ª—é–∑–∏–π –∏ –ª–∂–∏. –ë—É–¥—å –≥–æ—Ç–æ–≤ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç—è–º.", "m": "–ñ–µ–ª–∞–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–∞—Ç—å, —Ä–∏—Å–∫ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª, –∞–ø–∞—Ç–∏—è, –ø–∞–Ω–∏–∫–∞ –∏–ª–∏ –±–µ—Å–ø—Ä–∏—á–∏–Ω–Ω—ã–π —Å—Ç—Ä–∞—Ö."},
    "5": {"n": "–ì–æ–¥ —É–¥–∞—á–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è", "d": "–ì–æ–¥ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –∏ —Ñ–æ—Ä—Ç—É–Ω—ã. –í—Ä–µ–º—è —Ä–∞—Å—à–∏—Ä—è—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã, –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å —á–µ—Ä–µ–∑ –ª–æ–≥–∏–∫—É.", "r": "–ü—É—Ç–µ—à–µ—Å—Ç–≤—É–π, —Ä–∞—Å—à–∏—Ä—è–π —Å–≤—è–∑–∏, —Å—Ç—Ä–æ–π –±–∏–∑–Ω–µ—Å. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏ –ø—É–±–ª–∏—á–Ω—ã—Ö –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π.", "m": "–ë–æ—Ä—å–±–∞ –∑–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –Ω–µ–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ –≤ —Ä–µ—à–µ–Ω–∏—è—Ö, –Ω–µ–∂–µ–ª–∞–Ω–∏–µ —Å–ª—É—à–∞—Ç—å –¥—Ä—É–≥–∏—Ö."},
    "6": {"n": "–ì–æ–¥ —É—Å–ø–µ—Ö–∞ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–∞", "d": "–í—Ä–µ–º—è –ª—é–±–≤–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –∏ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–∏–Ω–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. –ü–µ—Ä–∏–æ–¥ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞, —É–¥–∞—á–∏ –∏ —Å–µ–º–µ–π–Ω–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.", "r": "–î–∞—Ä–∏ –ª—é–±–æ–≤—å, –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π –≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, —Å–æ–∑–¥–∞–≤–∞–π –∫–æ–º—Ñ–æ—Ä—Ç. –°—Ç–∞–≤—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏. –≤—ã—Ä–∞–∂–∞–π —ç–º–æ—Ü–∏–∏ –ª—é–±–≤–∏.", "m": "–ú—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ª–µ–Ω—å, –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤—ã–µ —Å–≤—è–∑–∏, –¥–æ–ª–≥–∏, –æ–±–æ—Å—Ç—Ä–µ–Ω–∏–µ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π."},
    "7": {"n": "–ì–æ–¥ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∫—Ä–∏–∑–∏—Å–∞", "d": "–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π. –û—Ç—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–º—ã.", "r": "–ü—Ä–∏–Ω–∏–º–∞–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π –∫—Ä–∏–∑–∏—Å –∫–∞–∫ —Ç–æ—á–∫—É —Ä–æ—Å—Ç–∞. –ë–æ–ª—å—à–µ –¥–≤–∏–≥–∞–π—Å—è (—Ö–æ–¥—å–±–∞). –ù–µ –Ω–∞—á–∏–Ω–∞–π –Ω–æ–≤—ã–µ –∫—Ä—É–ø–Ω—ã–µ –¥–µ–ª–∞.", "m": "–•–∞–æ—Å, –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –æ—Ç—á–∞—è–Ω–∏–µ, —Ä–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç—å, –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∏–∑–∏—Å–∞."},
    "8": {"n": "–ì–æ–¥ —Ç—Ä—É–¥–∞ –∏ –æ–±—É—á–µ–Ω–∏—è", "d": "–í—Ä–µ–º—è, –∫–æ–≥–¥–∞ —É—Å–ø–µ—Ö –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ–±—É—á–µ–Ω–∏–µ, —Ç—Ä—É–¥ –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É. –í—Å–µ, —á—Ç–æ –Ω–∞—Ä–∞–±–æ—Ç–∞–µ—à—å, –±—É–¥–µ—Ç —Å–ª—É–∂–∏—Ç—å –¥–æ–ª–≥–∏–µ –≥–æ–¥—ã.", "r": "–£—á–∏—Å—å, —Ç—Ä—É–¥–∏—Å—å, –ø–æ–∫—É–ø–∞–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å. –ò–∑–±–µ–≥–∞–π –∫—Ä–µ–¥–∏—Ç–æ–≤. –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π –≤ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ. –ù–µ –∑–∞–∫–ª—é—á–∞–π –±—Ä–∞–∫–∏.", "m": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —É—Å—Ç–∞–ª–æ—Å—Ç—å, –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –ø–æ–ª–Ω—ã–π —É—Ö–æ–¥ –≤ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ –∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è."},
    "9": {"n": "–ì–æ–¥ —Å–ª—É–∂–µ–Ω–∏—è –∏ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è", "d": "–í—Ä–µ–º—è –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –æ—Ç –≤—Å–µ–≥–æ –Ω–µ–Ω—É–∂–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ü–∏–∫–ª–æ–º. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ.", "r": "–ü–æ–∑–≤–æ–ª—å —É–π—Ç–∏ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É. –ü—Ä–æ—Å—Ç–∏ –æ–±–∏–¥—ã. –ü–æ–º–æ–≥–∞–π –ª—é–¥—è–º. –£–¥–µ–ª–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—é. –ü–æ–¥–≥–æ—Ç–æ–≤—å –º–µ—Å—Ç–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ.", "m": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏, —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ –±–µ–∑ —Å–æ–∑–∏–¥–∞–Ω–∏—è, –∞–≥—Ä–µ—Å—Å–∏—è."}
}

DESC_LM = {
    "1": {"n": "–•–æ—Ä–æ—à–∏–π –º–µ—Å—è—Ü –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–µ–ª", "d": "–í–∞–∂–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è –ª–∏–¥–µ—Ä—Å—Ç–≤–∞ –∏ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –£—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è –≤–ª–∏—è–Ω–∏—è.", "m": "–°–∏–ª—å–Ω—ã–π —ç–≥–æ–∏–∑–º, –¥–µ—Å–ø–æ—Ç–∏–∑–º, –Ω–µ–æ–±–¥—É–º–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∞–≤–∞–Ω—Ç—é—Ä–∏–∑–º."},
    "2": {"n": "–ú–µ—Å—è—Ü –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏", "d": "–ê–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π, —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –í–∞–∂–Ω–æ –ø—Ä–æ—è–≤–ª—è—Ç—å –º—è–≥–∫–æ—Å—Ç—å. –†–µ—à–µ–Ω–∏—è –ª—É—á—à–µ –æ—Ç–ª–æ–∂–∏—Ç—å. –ü–µ–π –±–æ–ª—å—à–µ –≤–æ–¥—ã.", "m": "–ú–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–æ–º–Ω–µ–Ω–∏—è, –¥–µ–ø—Ä–µ—Å—Å–∏—è, –∂–µ–ª–∞–Ω–∏–µ –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è."},
    "3": {"n": "–ú–µ—Å—è—Ü –∞–Ω–∞–ª–∏–∑–∞ –∏ —É—Å–ø–µ—Ö–∞", "d": "–î–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑: —Å–Ω–∞—á–∞–ª–∞ –¥—É–º–∞—Ç—å, –ø–æ—Ç–æ–º –¥–µ–ª–∞—Ç—å. –•–æ—Ä–æ—à–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è, —ç–∫–∑–∞–º–µ–Ω–æ–≤ –∏ –º–µ–¥–∏—Ü–∏–Ω—ã. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–ª–∞–Ω—ã.", "m": "–ö–æ—Ä—ã—Å—Ç—å, –ª–µ–Ω—å, –∞–∑–∞—Ä—Ç, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ª–µ–≥–∫–æ–π –≤—ã–≥–æ–¥–µ –±–µ–∑ —É—Å–∏–ª–∏–π."},
    "4": {"n": "–ú–µ—Å—è—Ü –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π", "d": "–í—Ä–µ–º—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–µ–π. –°–∏–ª—å–Ω–µ–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —á—É–≤—Å—Ç–≤–æ —ç—Å—Ç–µ—Ç–∏–∫–∏. –ë—É–¥—å —á–µ—Å—Ç–µ–Ω –≤–æ –≤—Å–µ–º.", "m": "–û–±–∏–¥—á–∏–≤–æ—Å—Ç—å, —Å—Ç—Ä–∞—Ö–∏, –ø–∞–Ω–∏–∫–∞, –ø–æ—Ç–µ—Ä—è –ª–æ–≥–∏–∫–∏, —Ö–æ–ª–æ–¥–Ω–æ—Å—Ç—å, –≤—Å–∫—Ä—ã—Ç–∏–µ —Ç–∞–π–Ω."},
    "5": {"n": "–ú–µ—Å—è—Ü –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è", "d": "–í—Ä–µ–º—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –ø–æ–µ–∑–¥–æ–∫ –∏ –Ω–æ–≤—ã—Ö —Å–≤—è–∑–µ–π. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.", "m": "–ù–µ–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –±–æ—Ä—å–±–∞ –∑–∞ –≤—ã–º—ã—à–ª–µ–Ω–Ω—É—é —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å."},
    "6": {"n": "–ú–µ—Å—è—Ü –ª—é–±–≤–∏ –∏ —É—Å–ø–µ—Ö–∞", "d": "–ü–µ—Ä–∏–æ–¥ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ —É–¥–∞—á–∏. –£—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –∏–Ω—Ç—É–∏—Ü–∏—è –Ω–∞ –¥–µ–Ω—å–≥–∏ –∏ –º—É–¥—Ä–æ—Å—Ç—å. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è –±—Ä–∞–∫–∞ –∏ –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫.", "m": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∏–∑–ª–∏—à–µ—Å—Ç–≤–∞, —Å–æ–±–ª–∞–∑–Ω –Ω–µ—á–µ—Å—Ç–Ω–æ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞, –º—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å."},
    "7": {"n": "–ú–µ—Å—è—Ü —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏", "d": "–í–∞–∂–Ω–æ –∂–∏—Ç—å –≤ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ. –õ–∏–±–æ –≤–∑–ª–µ—Ç, –ª–∏–±–æ –ø–∞–¥–µ–Ω–∏–µ. –£—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –∏–Ω—Ç—É–∏—Ü–∏—è –∏ —ç–Ω–µ—Ä–≥–∏—è. –ü–æ–ª–µ–∑–Ω—ã –π–æ–≥–∞ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏.", "m": "–≠–≥–æ–∏–∑–º, —Ö–∞–æ—Å –≤ –º—ã—Å–ª—è—Ö, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤—É, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å—Ä—ã–≤—ã."},
    "8": {"n": "–ú–µ—Å—è—Ü —Ç—Ä—É–¥–∞ –∏ –æ–±—É—á–µ–Ω–∏—è", "d": "–ñ–µ–ª–∞–Ω–∏–µ —Ç—Ä—É–¥–∏—Ç—å—Å—è, –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –º–µ–ª–æ—á–∞–º, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –ü–æ–≤—ã—à–∞–π –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é, –Ω–µ –±–µ—Ä–∏ –∫—Ä–µ–¥–∏—Ç—ã.", "m": "–ß—Ä–µ–∑–º–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –Ω–µ–¥–æ–≤–µ—Ä–∏–µ, –ø–æ—Ç–µ—Ä–∏, –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–º, —Ç—É–Ω–µ—è–¥—Å—Ç–≤–æ."},
    "9": {"n": "–ú–µ—Å—è—Ü –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏", "d": "–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ª. –ü–æ–¥–≤–æ–¥–∏ –∏—Ç–æ–≥–∏ –∏ –æ—Ç–ø—É—Å–∫–∞–π –ª–∏—à–Ω–µ–µ. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–º–æ—â–∏.", "m": "–í–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã–µ –º—ã—Å–ª–∏."}
}

DESC_LD = {
    "1": "–î–µ–Ω—å –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π. –õ—é–±–æ–µ –Ω–∞—á–∞–ª–æ –ø–æ–ª—É—á–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É —ç–Ω–µ—Ä–≥–∏–∏ –¥–Ω—è. –ë—É–¥—å—Ç–µ —Å–º–µ–ª—ã–º–∏, —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –Ω–æ –∏–∑–±–µ–≥–∞–π—Ç–µ —ç–≥–æ–∏–∑–º–∞.",
    "2": "–î–µ–Ω—å –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –°–ª—É—à–∞–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ, –Ω–∞–ª–∞–∂–∏–≤–∞–π—Ç–µ —Å–≤—è–∑–∏. –ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –¥—É—à –∏–ª–∏ –≥—É–ª—è–π—Ç–µ —É –≤–æ–¥—ã ‚Äî —ç—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –≤–∞—à—É —ç–Ω–µ—Ä–≥–∏—é.",
    "3": "–î–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –≠–Ω–µ—Ä–≥–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–µ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è. –£–¥–∞—á–Ω–æ –¥–ª—è –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É. –ò–∑–±–µ–≥–∞–π—Ç–µ –∞–∑–∞—Ä—Ç–∞.",
    "4": "–î–µ–Ω—å –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π. –°—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏, –±—É–¥—å—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã –∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ —á–µ—Å—Ç–Ω—ã. –ù–µ –≤–ø–∞–¥–∞–π—Ç–µ –≤ –æ–±–∏–¥—ã.",
    "5": "–î–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –û—Ç–ª–∏—á–Ω–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –∏ –ø–æ–µ–∑–¥–æ–∫. –õ–æ–≥–∏–∫–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –≤–∞—à –ª—É—á—à–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.",
    "6": "–î–µ–Ω—å —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ –ª—é–±–≤–∏. –î–∞—Ä–∏—Ç–µ –∑–∞–±–æ—Ç—É, –ø—Ä–æ—è–≤–ª—è–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –±–ª–∏–∑–∫–∏–º. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–º—Ñ–æ—Ä—Ç –¥–ª—è –æ–∫—Ä—É–∂–∞—é—â–∏—Ö.",
    "7": "–î–µ–Ω—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ù–∞—á–Ω–∏—Ç–µ —É—Ç—Ä–æ —Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã —Ç–µ–ª–∞ (—Ö–æ–¥—å–±–∞). –ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å–ø–æ–∫–æ–π–Ω–æ ‚Äî –∫–∞–∫ —Ü–µ–Ω–Ω—ã–π –æ–ø—ã—Ç.",
    "8": "–î–µ–Ω—å –æ–±—É—á–µ–Ω–∏—è –∏ —Ç—Ä—É–¥–∞. –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–≤—ã–∫–∏ –ø—Ä–∏–Ω–µ—Å—É—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±—É–¥—É—â–µ–º. –ö—Ä–µ–¥–∏—Ç—ã –±—Ä–∞—Ç—å –Ω–µ —Å—Ç–æ–∏—Ç.",
    "9": "–î–µ–Ω—å –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏. –û—Ç–¥–∞–≤–∞–π—Ç–µ –¥–æ–ª–≥–∏, –ø–æ–º–æ–≥–∞–π—Ç–µ –ª—é–¥—è–º, –ø–æ—Å–µ—Ç–∏—Ç–µ –±–∞–Ω—é. –°–ø–æ–∫–æ–π–Ω–æ –æ—Ç–ø—É—Å–∫–∞–π—Ç–µ —Å—Ç–∞—Ä–æ–µ."
}

# ================= –ö–õ–ê–í–ò–ê–¢–£–†–´ =================
def tz_keyboard():
    return ReplyKeyboardMarkup(
        [[KeyboardButton("üá∞üáø –ê–ª–º–∞—Ç—ã"), KeyboardButton("üá∑üá∫ –ú–æ—Å–∫–≤–∞")]],
        resize_keyboard=True,
        one_time_keyboard=True,
    )


def time_keyboard():
    return ReplyKeyboardMarkup(
        [
            [KeyboardButton("09:00"), KeyboardButton("12:00")],
            [KeyboardButton("18:00"), KeyboardButton("21:00")],
        ],
        resize_keyboard=True,
        one_time_keyboard=True,
    )


def main_keyboard():
    return ReplyKeyboardMarkup(
        [[KeyboardButton("üìÖ –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑")]],
        resize_keyboard=True,
    )


# ================= –£–¢–ò–õ–ò–¢–´ =================
def reduce9(n: int) -> int:
    while n > 9:
        n = sum(map(int, str(n)))
    return n


def validate_date(text: str):
    try:
        d = datetime.strptime(text, "%d.%m.%Y")
        if d > datetime.now():
            return None
        return d
    except ValueError:
        return None


def validate_time(text: str) -> bool:
    try:
        datetime.strptime(text, "%H:%M")
        return True
    except ValueError:
        return False


# ================= GOOGLE SHEETS =================
def get_ws():
    creds_json = json.loads(base64.b64decode(GOOGLE_SA_JSON_B64).decode())
    creds = Credentials.from_service_account_info(
        creds_json,
        scopes=["https://www.googleapis.com/auth/spreadsheets"],
    )
    return gspread.authorize(creds).open_by_key(GSHEET_ID).worksheet("subscriptions")


def sync_user(update: Update, **fields):
    """
    –•—Ä–∞–Ω–∏–º:
    0 uid
    4 birth
    12 tz
    13 notify_time
    14 step
    """
    try:
        ws = get_ws()
        uid = str(update.effective_user.id)
        rows = ws.get_all_values()
        now = datetime.now().strftime("%d.%m.%Y %H:%M")

        for i, r in enumerate(rows, start=1):
            if r and r[0] == uid:
                if "birth" in fields:
                    ws.update_cell(i, 5, fields["birth"])
                if "tz" in fields:
                    ws.update_cell(i, 13, fields["tz"])
                if "notify_time" in fields:
                    ws.update_cell(i, 14, fields["notify_time"])
                if "step" in fields:
                    ws.update_cell(i, 15, fields["step"])

                ws.update_cell(i, 7, now)

                row = ws.row_values(i)
                row += [""] * (15 - len(row))
                return row

        # –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        row = [
            uid,
            "active",
            "trial",
            (datetime.now() + timedelta(days=3)).strftime("%d.%m.%Y"),
            fields.get("birth", ""),
            now,
            now,
            update.effective_user.username or "",
            update.effective_user.first_name or "",
            update.effective_user.last_name or "",
            datetime.now().strftime("%d.%m.%Y"),
            "",
            fields.get("tz", ""),
            fields.get("notify_time", ""),
            fields.get("step", WAIT_TZ),
        ]
        ws.append_row(row)
        return row

    except Exception:
        log.exception("GSheet error")
        return None


# ================= –ü–†–û–ì–ù–û–ó =================
async def send_full_forecast(u: Update, row):
    try:
        birth_raw = row[4].strip()
        tz_name = row[12] or DEFAULT_TZ

        bd = datetime.strptime(birth_raw, "%d.%m.%Y")
        tz = pytz.timezone(tz_name)
        now = datetime.now(tz)

        lg = reduce9(bd.day + bd.month + now.year)
        lm = reduce9(lg + now.month)
        ld = reduce9(lm + now.day)
        od = reduce9(now.day + now.month + now.year)

        msg = f"üìÖ *–ü–†–û–ì–ù–û–ó –ù–ê {now.strftime('%d.%m.%Y')}*\n\n"
        msg += f"üåê *–û–±—â–∏–π –¥–µ–Ω—å:* {od}\n\n"

        y = DESC_LG.get(str(lg), {})
        m = DESC_LM.get(str(lm), {})

        msg += f"‚ú® *–õ–∏—á–Ω—ã–π –≥–æ–¥ {lg}: {y.get('n','')}*\n_{y.get('d','')}_\n"
        msg += f"*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* {y.get('r','')}\n"
        msg += f"*–í –º–∏–Ω—É—Å–µ:* {y.get('m','')}\n\n"

        msg += f"üåô *–õ–∏—á–Ω—ã–π –º–µ—Å—è—Ü {lm}: {m.get('n','')}*\n_{m.get('d','')}_\n"
        msg += f"*–í –º–∏–Ω—É—Å–µ:* {m.get('m','')}\n\n"

        msg += f"üìç *–õ–∏—á–Ω—ã–π –¥–µ–Ω—å {ld}:*\n{DESC_LD.get(str(ld),'')}"

        await u.message.reply_text(
            msg,
            parse_mode="Markdown",
            reply_markup=main_keyboard(),
        )

    except Exception:
        log.exception("Forecast error")
        await u.message.reply_text("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞.")


# ================= HANDLERS =================
async def start(u: Update, c: ContextTypes.DEFAULT_TYPE):
    sync_user(u, step=WAIT_TZ)
    await u.message.reply_text(
        "–í—ã–±–µ—Ä–∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:",
        reply_markup=tz_keyboard(),
    )


async def handle_msg(u: Update, c: ContextTypes.DEFAULT_TYPE):
    text = u.message.text.strip()
    row = sync_user(u)
    step = row[14] if row and len(row) > 14 else WAIT_TZ

    # -------- WAIT_TZ --------
    if step == WAIT_TZ:
        if text in ["üá∞üáø –ê–ª–º–∞—Ç—ã", "üá∑üá∫ –ú–æ—Å–∫–≤–∞"]:
            tz = "Asia/Almaty" if "–ê–ª–º–∞—Ç—ã" in text else "Europe/Moscow"
            sync_user(u, tz=tz, step=WAIT_NOTIFY_TIME)
            await u.message.reply_text(
                "–í—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ –≤–≤–µ–¥–∏ —Å–≤–æ—ë (–ß–ß:–ú–ú):",
                reply_markup=time_keyboard(),
            )
        else:
            await u.message.reply_text(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∫–Ω–æ–ø–∫–æ–π.",
                reply_markup=tz_keyboard(),
            )
        return

    # -------- WAIT_NOTIFY_TIME --------
    if step == WAIT_NOTIFY_TIME:
        if validate_time(text):
            sync_user(u, notify_time=text, step=WAIT_BIRTH)
            await u.message.reply_text(
                "–í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.\n–í–≤–µ–¥–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì):",
                reply_markup=ReplyKeyboardRemove(),
            )
        else:
            await u.message.reply_text(
                "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú, –Ω–∞–ø—Ä–∏–º–µ—Ä 08:30",
                reply_markup=time_keyboard(),
            )
        return

    # -------- WAIT_BIRTH --------
    if step == WAIT_BIRTH:
        bd = validate_date(text)
        if bd:
            row = sync_user(u, birth=text, step=READY)
            await send_full_forecast(u, row)
        else:
            await u.message.reply_text(
                "–î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì",
            )
        return

    # -------- READY --------
    if step == READY:
        if text == "üìÖ –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑":
            await send_full_forecast(u, row)
        else:
            await u.message.reply_text(
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑¬ª.",
                reply_markup=main_keyboard(),
            )
        return


# ================= SERVER =================
app = Flask(__name__)
application = Application.builder().token(TELEGRAM_TOKEN).build()

application.add_handler(CommandHandler("start", start))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_msg))


# ================= EVENT LOOP =================
loop = asyncio.new_event_loop()

def run_loop():
    asyncio.set_event_loop(loop)
    loop.run_forever()

threading.Thread(target=run_loop, daemon=True).start()


@app.route("/webhook", methods=["POST"])
def webhook():
    update = Update.de_json(request.get_json(force=True), application.bot)
    asyncio.run_coroutine_threadsafe(application.process_update(update), loop)
    return "OK", 200


@app.route("/")
def index():
    return "Bot is running", 200


if __name__ == "__main__":
    asyncio.run_coroutine_threadsafe(application.initialize(), loop)
    asyncio.run_coroutine_threadsafe(application.start(), loop)
    asyncio.run_coroutine_threadsafe(
        application.bot.set_webhook(f"{PUBLIC_URL}/webhook"),
        loop,
    )

    app.run(
        host="0.0.0.0",
        port=int(os.environ.get("PORT", 10000)),
    )