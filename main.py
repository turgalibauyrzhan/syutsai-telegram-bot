import os
import json
import base64
import logging
from datetime import datetime, date
import pytz

from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters
import gspread
from google.oauth2.service_account import Credentials
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
PUBLIC_URL = os.getenv("PUBLIC_URL")
GSHEET_ID = os.getenv("GSHEET_ID")
GOOGLE_SA_JSON_B64 = os.getenv("GOOGLE_SA_JSON_B64")
TZ = pytz.timezone("Asia/Almaty")

# --- –î–ê–ù–ù–´–ï –ò–ó –í–ê–®–ò–• –¢–ê–ë–õ–ò–¶ (–í–®–ò–¢–´ –í –ö–û–î) ---
TEXTS = {
    "UNFAVORABLE": "‚ö†Ô∏è –ù–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ —Å–æ–±—ã—Ç–∏—è. –ï—Å—Ç—å –≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±–Ω—É–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏, –¥–æ–≥–æ–≤–æ—Ä—ã, –∫—Ä–µ–¥–∏—Ç—ã –∏ —Ç.–¥.",
    "OD": {
        "3": "üåü *–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å (–û–î 3)*\n–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑, —É—Å–ø–µ—Ö. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±—Ä–∞–∫–∞, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫.",
        "6": "üíñ *–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å (–û–î 6)*\n–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å —á–µ—Ä–µ–∑ –ª—é–±–æ–≤—å –∏ —É—Å–ø–µ—Ö. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π, –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —Å–µ–º–µ–π–Ω—ã—Ö –¥–µ–ª."
    },
    "LG": {
        "1": {"t": "–õ–ì 1. –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞", "d": "–í—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ 9 –ª–µ—Ç. –ú–æ—â–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫.", "r": "–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —Å–≤–æ–µ –¥–µ–ª–æ, —Ä–∞–∑–≤–∏–≤–∞–π—Ç–µ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø–æ–∑–∏—Ç–∏–≤."},
        "2": {"t": "–õ–ì 2. –ì–æ–¥ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏", "d": "–ü–µ—Ä–∏–æ–¥ –ø–µ—Ä–µ–º–µ–Ω –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö. –°—Ç–∞—Ä–æ–µ —É—Ö–æ–¥–∏—Ç, –Ω–æ–≤–æ–µ —Å—Ç—Ä–æ–∏—Ç—Å—è.", "r": "–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –≥–∏–±–∫–æ—Å—Ç—å, –Ω–µ —Ü–µ–ø–ª—è–π—Ç–µ—Å—å –∑–∞ —Å—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏."},
        "3": {"t": "–õ–ì 3. –ì–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –∏ —É—Å–ø–µ—Ö–∞", "d": "–ì–æ–¥ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—ä–µ–º–∞ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ä–∞—Å—á–µ—Ç.", "r": "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è, –¥–µ–π—Å—Ç–≤—É–π—Ç–µ —á–µ—Ä–µ–∑ –ª–æ–≥–∏–∫—É, –∞ –Ω–µ —ç–º–æ—Ü–∏–∏."},
        "4": {"t": "–õ–ì 4. –ì–æ–¥ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏", "d": "–ì–æ–¥ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏ –≥–ª—É–±–æ–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.", "r": "–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω—ã, —Ä–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–æ–π."},
        "5": {"t": "–õ–ì 5. –ì–æ–¥ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π", "d": "–í—Ä–µ–º—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–≤—è–∑–µ–π –∏ –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.", "r": "–ë—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤–æ–º—É, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤—è–∑–∏ –¥–ª—è —Ä–æ—Å—Ç–∞."},
        "6": {"t": "–õ–ì 6. –ì–æ–¥ –ª—é–±–≤–∏ –∏ —É—Å–ø–µ—Ö–∞", "d": "–ì–æ–¥ —Å–µ–º–µ–π–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–ø–ª–∞.", "r": "–£–∫—Ä–µ–ø–ª—è–π—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –ø—Ä–æ—è–≤–ª—è–π—Ç–µ –∑–∞–±–æ—Ç—É."},
        "7": {"t": "–õ–ì 7. –ì–æ–¥ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏", "d": "–ì–ª—É–±–∏–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ —Å–æ–±–æ–π, –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–º—ã.", "r": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—Ä–∏–∑–∏—Å –∫–∞–∫ —Ç–æ—á–∫—É —Ä–æ—Å—Ç–∞, –Ω–µ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –Ω–æ–≤–æ–µ."},
        "8": {"t": "–õ–ì 8. –ì–æ–¥ —Ç—Ä—É–¥–∞ –∏ –æ–±—É—á–µ–Ω–∏—è", "d": "–£—Å–ø–µ—Ö —á–µ—Ä–µ–∑ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏.", "r": "–¢—Ä—É–¥–∏—Ç–µ—Å—å, –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –∑–Ω–∞–Ω–∏—è, –∏–∑–±–µ–≥–∞–π—Ç–µ –∫—Ä–µ–¥–∏—Ç–æ–≤."},
        "9": {"t": "–õ–ì 9. –ì–æ–¥ —Å–ª—É–∂–µ–Ω–∏—è", "d": "–ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.", "r": "–ü—Ä–æ—â–∞–π—Ç–µ –æ–±–∏–¥—ã, –ø–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥–∏–º, –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ –¥–µ–ª–∞."}
    },
    "LM": {
        "1": "–ú–µ—Å—è—Ü —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.",
        "2": "–ú–µ—Å—è—Ü –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏, —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π.",
        "3": "–ú–µ—Å—è—Ü –∞–Ω–∞–ª–∏–∑–∞: —Å–Ω–∞—á–∞–ª–∞ –¥—É–º–∞–µ–º, –ø–æ—Ç–æ–º –¥–µ–ª–∞–µ–º.",
        "4": "–ú–µ—Å—è—Ü –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π, –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∫–æ–π.",
        "5": "–ú–µ—Å—è—Ü —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –ø–æ–µ–∑–¥–æ–∫ –∏ –Ω–æ–≤—ã—Ö –∏–¥–µ–π.",
        "6": "–ú–µ—Å—è—Ü —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞, —É–¥–∞—á–∏ –≤ –ª—é–±–≤–∏ –∏ –¥–µ–Ω—å–≥–∞—Ö.",
        "7": "–ú–µ—Å—è—Ü –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã: –ª–∏–±–æ –≤–∑–ª–µ—Ç, –ª–∏–±–æ –ø–∞–¥–µ–Ω–∏–µ.",
        "8": "–ú–µ—Å—è—Ü –∫–æ–Ω—Ç—Ä–æ–ª—è, –º—É–¥—Ä–æ—Å—Ç–∏ –∏ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –º–µ–ª–æ—á–∞–º.",
        "9": "–ú–µ—Å—è—Ü –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –æ—á–∏—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞."
    },
    "LD": {
        "1": "–î–µ–Ω—å –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π. –õ—é–±–æ–µ –¥–µ–ª–æ –ø–æ–ª—É—á–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
        "2": "–î–µ–Ω—å –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –ü—Ä–æ—è–≤–ª—è–π—Ç–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ.",
        "3": "–î–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞. –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ ‚Äî —ç–Ω–µ—Ä–≥–∏—è –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è–º.",
        "4": "–î–µ–Ω—å –º–∏—Å—Ç–∏–∫–∏. –°–æ–±—ã—Ç–∏—è –≤–Ω–µ –ª–æ–≥–∏–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —É–º —Ç—Ä–µ–∑–≤—ã–º.",
        "5": "–î–µ–Ω—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π, –æ–±—â–µ–Ω–∏—è –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞–∫–æ–º—Å—Ç–≤.",
        "6": "–î–µ–Ω—å –∑–∞–±–æ—Ç—ã –∏ –∫–æ–º—Ñ–æ—Ä—Ç–∞. –î–∞—Ä–∏—Ç–µ —Ç–µ–ø–ª–æ –±–ª–∏–∑–∫–∏–º.",
        "7": "–î–µ–Ω—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ù–∞—á–Ω–∏—Ç–µ —É—Ç—Ä–æ —Å —Ö–æ–¥—å–±—ã –∏–ª–∏ –º–µ–¥–∏—Ç–∞—Ü–∏–∏.",
        "8": "–î–µ–Ω—å –æ–±—É—á–µ–Ω–∏—è –∏ —Ç—Ä—É–¥–∞. –ù–∞–≤—ã–∫–∏ –ø—Ä–∏–Ω–µ—Å—É—Ç –¥–æ—Ö–æ–¥ –≤ –±—É–¥—É—â–µ–º.",
        "9": "–î–µ–Ω—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏. –û—Ç–¥–∞–≤–∞–π—Ç–µ –¥–æ–ª–≥–∏ –∏ –ø–æ–º–æ–≥–∞–π—Ç–µ –ª—é–¥—è–º."
    }
}

# --- –õ–û–ì–ò–ö–ê ---
def reduce9(n: int) -> int:
    while n > 9: n = sum(map(int, str(n)))
    return n

def calculate(bd: date, target: date):
    od = reduce9(target.day + target.month + target.year)
    lg = reduce9(bd.day + bd.month + target.year)
    lm = reduce9(lg + target.month)
    ld = reduce9(lm + target.day)
    return od, lg, lm, ld

# --- GOOGLE SHEETS ---
def upsert_user(uid, bday):
    try:
        sa_info = json.loads(base64.b64decode(GOOGLE_SA_JSON_B64).decode("utf-8"))
        creds = Credentials.from_service_account_info(sa_info, scopes=["https://www.googleapis.com/auth/spreadsheets"])
        gc = gspread.authorize(creds)
        ws = gc.open_by_key(GSHEET_ID).worksheet("subscriptions")
        
        rows = ws.get_all_records()
        now_str = datetime.now(TZ).isoformat()
        
        for i, r in enumerate(rows, start=2):
            if str(r.get("telegram_user_id")) == str(uid):
                ws.update_cell(i, 2, bday) # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
                ws.update_cell(i, 4, now_str) # –û–±–Ω–æ–≤–ª—è–µ–º last_seen
                return
        ws.append_row([uid, bday, now_str, now_str])
    except Exception as e:
        log.error(f"GS Error: {e}")

# --- –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê ---
def get_prognoz(bd_str: str):
    bd = datetime.strptime(bd_str, "%d.%m.%Y").date()
    today = datetime.now(TZ).date()
    od, lg, lm, ld = calculate(bd, today)
    
    res = f"üìÖ *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {today.strftime('%d.%m.%Y')}*\n\n"
    
    # –ë–ª–æ–∫ –û–±—â–µ–≥–æ –î–Ω—è
    if today.day in {10, 20, 30}:
        res += f"{TEXTS['UNFAVORABLE']}\n\n"
    elif str(od) in TEXTS["OD"]:
        res += f"{TEXTS['OD'][str(od)]}\n\n"
    else:
        res += f"üåê *–û–±—â–∏–π –¥–µ–Ω—å:* {od}\n\n"

    # –õ–∏—á–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
    g = TEXTS["LG"][str(lg)]
    res += f"‚ú® *{g['t']}*\n_{g['d']}_\nüí° {g['r']}\n\n"
    res += f"üåô *–õ–∏—á–Ω—ã–π –º–µ—Å—è—Ü {lm}:* {TEXTS['LM'][str(lm)]}\n\n"
    res += f"üìç *–õ–∏—á–Ω—ã–π –¥–µ–Ω—å {ld}:* {TEXTS['LD'][str(ld)]}"
    
    return res

# --- HANDLERS ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤–∞—à–µ–≥–æ —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–î–î.–ú–ú.–ì–ì–ì–ì*", parse_mode="Markdown")

async def handle_msg(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    uid = update.effective_user.id
    
    if text == "–°–µ–≥–æ–¥–Ω—è":
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –¥–∞—Ç—É, –µ—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì)")
        return

    try:
        datetime.strptime(text, "%d.%m.%Y")
        upsert_user(uid, text)
        msg = get_prognoz(text)
        await update.message.reply_text(msg, parse_mode="Markdown", 
                                       reply_markup=ReplyKeyboardMarkup([["–°–µ–≥–æ–¥–Ω—è"]], resize_keyboard=True))
    except ValueError:
        await update.message.reply_text("‚ùå –§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.05.1990)")

# --- –ó–ê–ü–£–°–ö ---
application = Application.builder().token(TELEGRAM_TOKEN).build()
application.add_handler(CommandHandler("start", start))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_msg))

async def post_init(app: Application):
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º –≤–µ–±—Ö—É–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
    webhook_url = f"{PUBLIC_URL}/webhook"
    await app.bot.set_webhook(webhook_url)
    log.info(f"‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: {webhook_url}")

if __name__ == "__main__":
    # –£–∫–∞–∑—ã–≤–∞–µ–º post_init –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    application.post_init = post_init
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞–ª Render
    port = int(os.environ.get("PORT", 8080))
    
    log.info(f"üöÄ –ó–∞–ø—É—Å–∫ –≤–µ–±—Ö—É–∫–∞ –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    
    application.run_webhook(
        listen="0.0.0.0",
        port=port,
        webhook_url=f"{PUBLIC_URL}/webhook",
        # –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π Render —Å–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
        allowed_updates=Update.ALL_TYPES 
    )