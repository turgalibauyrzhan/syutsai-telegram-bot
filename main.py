import os, json, base64, logging, asyncio
from datetime import datetime, timedelta
import pytz
import asyncio

from flask import Flask, request
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters
import gspread
from google.oauth2.service_account import Credentials

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
PUBLIC_URL = os.getenv("PUBLIC_URL", "").rstrip('/')
GSHEET_ID = os.getenv("GSHEET_ID")
GOOGLE_SA_JSON_B64 = os.getenv("GOOGLE_SA_JSON_B64")
ADMIN_CONTACT = "@knaddisyucai"

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• –¢–ï–ö–°–¢–û–í (–ò–ó –í–ê–®–ò–• CSV) ---

DESC_LG = {
    "1": {"desc": "–≠—Ç–æ –≤—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 9 –ª–µ—Ç. –ü—Ä–∏—Ö–æ–¥–∏—Ç —Å–∞–º—ã–π –º–æ—â–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫.", "rec": "–û—Ç–∫—Ä—ã–≤–∞–π —Å–≤–æ–µ –¥–µ–ª–æ, —Ä–∞–∑–≤–∏–≤–∞–π –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, —É—á–∏—Å—å –±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.", "minus": "–ñ–∂–µ–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç–∏ —Å–µ—Ä–¥—Ü–∞, –¥–µ–ø—Ä–µ—Å—Å–∏—è, –ø—É—Å—Ç–æ—Ç–∞."},
    "2": {"desc": "–ì–æ–¥ –ø–µ—Ä–µ–º–µ–Ω –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –ù–µ –ø—Ä–∏–Ω–∏–º–∞–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.", "rec": "–°—Ç—Ä–æ–π –Ω–æ–≤—ã–µ —Å–≤—è–∑–∏, –º—è–≥–∫–æ –æ—Ç–ø—É—Å–∫–∞–π —Å—Ç–∞—Ä–æ–µ, —Å–æ—Ö—Ä–∞–Ω—è–π –≥–∏–±–∫–æ—Å—Ç—å.", "minus": "–ë–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã, —Å–æ–º–Ω–µ–Ω–∏—è, –¥–µ–ø—Ä–µ—Å—Å–∏—è."},
    "3": {"desc": "–ì–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ –∏ —É—Å–ø–µ—Ö–∞. –ü—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ.", "rec": "–î–µ–π—Å—Ç–≤—É–π —á–µ—Ä–µ–∑ —Ä–∞—Å—á–µ—Ç, –ø–ª–∞–Ω–∏—Ä—É–π —à–∞–≥–∏ –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä–µ–¥, –≤–µ–¥–∏ —É—á–µ—Ç.", "minus": "–õ–µ–Ω—å, –∞–∑–∞—Ä—Ç, –∫–æ—Ä—ã—Å—Ç—å, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –±—ã—Å—Ç—Ä–æ–π –≤—ã–≥–æ–¥–µ."},
    "4": {"desc": "–ì–æ–¥ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–µ–π –∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π. –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤–µ–¥–µ—Ç –∫ —Ä–æ—Å—Ç—É.", "rec": "–°—Ç–∞–≤—å —Ü–µ–ª–∏, –∑–∞–Ω–∏–º–∞–π—Å—è –∫—Ä–µ–∞—Ç–∏–≤–æ–º, —á–µ—Å—Ç–Ω–æ —Ç—Ä—É–¥–∏—Å—å.", "minus": "–ñ–µ–ª–∞–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–∞—Ç—å, –∞–ø–∞—Ç–∏—è, —Ä–∏—Å–∫ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª."},
    "5": {"desc": "–ì–æ–¥ —É–¥–∞—á–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è.", "rec": "–†–∞—Å—à–∏—Ä—è–π —Å–≤—è–∑–∏, –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–π, —Å—Ç—Ä–æ–π –±–∏–∑–Ω–µ—Å —á–µ—Ä–µ–∑ –ª–æ–≥–∏–∫—É.", "minus": "–ë–æ—Ä—å–±–∞ –∑–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º, –Ω–µ–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ."},
    "6": {"desc": "–ì–æ–¥ —É—Å–ø–µ—Ö–∞, –∫–æ–º—Ñ–æ—Ä—Ç–∞, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –∏ –ª—é–±–≤–∏.", "rec": "–ó–∞–Ω–∏–º–∞–π—Å—è –¥–æ–º–æ–º, –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π, –ø—Ä–æ—è–≤–ª—è–π –∑–∞–±–æ—Ç—É, –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏.", "minus": "–ú—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ª–µ–Ω—å, –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤—ã–µ —Å–≤—è–∑–∏."},
    "7": {"desc": "–ì–æ–¥ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∫—Ä–∏–∑–∏—Å–∞. –í—Ä–µ–º—è –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –∫–∞—Ä–º—ã.", "rec": "–ü—Ä–∏–Ω–∏–º–∞–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –Ω–µ –Ω–∞—á–∏–Ω–∞–π –Ω–æ–≤–æ–µ –¥–µ–ª–æ, –±–æ–ª—å—à–µ –¥–≤–∏–≥–∞–π—Å—è.", "minus": "–•–∞–æ—Å, –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –æ—Ç—á–∞—è–Ω–∏–µ, —Ä–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç—å."},
    "8": {"desc": "–ì–æ–¥ —Ç—Ä—É–¥–∞ –∏ –æ–±—É—á–µ–Ω–∏—è. –£—Å–ø–µ—Ö —á–µ—Ä–µ–∑ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É.", "rec": "–ü–æ–∫—É–ø–∞–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, —É—á–∏—Å—å, –Ω–µ –±–µ—Ä–∏ –∫—Ä–µ–¥–∏—Ç—ã, –Ω–µ –≤—Å—Ç—É–ø–∞–π –≤ –±—Ä–∞–∫.", "minus": "–£—Å—Ç–∞–ª–æ—Å—Ç—å, –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ."},
    "9": {"desc": "–ì–æ–¥ —Å–ª—É–∂–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–∏–∫–ª–∞.", "rec": "–ü–æ–∑–≤–æ–ª—å —É–π—Ç–∏ —Å—Ç–∞—Ä–æ–º—É, –ø—Ä–æ—Å—Ç–∏ –æ–±–∏–¥—ã, —É–¥–µ–ª–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—é, –ø–æ–º–æ–≥–∞–π –ª—é–¥—è–º.", "minus": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–∑–ø–ª–µ—Å–∫–∏, —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ –±–µ–∑ —Å–æ–∑–∏–¥–∞–Ω–∏—è."}
}

DESC_LM = {
    "1": "–•–æ—Ä–æ—à–∏–π –º–µ—Å—è—Ü –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–µ–ª. –õ–∏–¥–µ—Ä—Å—Ç–≤–æ, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –£–∫—Ä–µ–ø–ª—è–π—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É.",
    "2": "–ú–µ—Å—è—Ü –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –ê–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã, –Ω–µ —Ä—É–±–∏—Ç–µ —Å –ø–ª–µ—á–∞.",
    "3": "–ú–µ—Å—è—Ü –∞–Ω–∞–ª–∏–∑–∞. –°–Ω–∞—á–∞–ª–∞ –¥—É–º–∞–π—Ç–µ, –ø–æ—Ç–æ–º –¥–µ–ª–∞–π—Ç–µ. –£–¥–∞—á–Ω–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –º–µ–¥–∏—Ü–∏–Ω—ã.",
    "4": "–ú–µ—Å—è—Ü –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–µ–π. –ö—Ä–µ–∞—Ç–∏–≤ –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å –ø–æ–º–æ–≥—É—Ç –∏–∑–±–µ–∂–∞—Ç—å –∏–ª–ª—é–∑–∏–π.",
    "5": "–ú–µ—Å—è—Ü –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –û—Ç–ª–∏—á–Ω–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –∏ –Ω–æ–≤—ã—Ö —Å–≤—è–∑–µ–π.",
    "6": "–ú–µ—Å—è—Ü –ª—é–±–≤–∏ –∏ —É—Å–ø–µ—Ö–∞. –ò–Ω—Ç—É–∏—Ü–∏—è –Ω–∞ –¥–µ–Ω—å–≥–∏. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è –±—Ä–∞–∫–∞ –∏ –ø–æ–∫—É–ø–æ–∫.",
    "7": "–ú–µ—Å—è—Ü —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ñ–∏–∑–Ω—å –≤ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ. –õ–∏–±–æ –≤–∑–ª–µ—Ç, –ª–∏–±–æ –ø–∞–¥–µ–Ω–∏–µ. –ü–æ–ª–µ–∑–Ω–∞ –π–æ–≥–∞.",
    "8": "–ú–µ—Å—è—Ü —Ç—Ä—É–¥–∞. –í–Ω–∏–º–∞–Ω–∏–µ –∫ –º–µ–ª–æ—á–∞–º, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –ü–æ–≤—ã—à–∞–π—Ç–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é.",
    "9": "–ú–µ—Å—è—Ü –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –í—Ä–µ–º—è —Å–ª—É–∂–µ–Ω–∏—è –∏ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤. –û—Ç–ø—É—Å–∫–∞–π—Ç–µ —Å—Ç–∞—Ä–æ–µ."
}

DESC_LD = {
    "1": "–î–µ–Ω—å –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π. –î–µ–π—Å—Ç–≤—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ —ç–≥–æ–∏–∑–º–∞.",
    "2": "–î–µ–Ω—å –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –°–ª—É—à–∞–π—Ç–µ –¥—Ä—É–≥–∏—Ö, –ø–µ–π—Ç–µ –≤–æ–¥—É, —É–∫—Ä–µ–ø–ª—è–π—Ç–µ —Å–≤—è–∑–∏.",
    "3": "–î–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞. –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ, –∏–∑–±–µ–≥–∞–π—Ç–µ –∞–∑–∞—Ä—Ç–∞ –∏ –ª–µ–≥–∫–æ–π –Ω–∞–∂–∏–≤—ã.",
    "4": "–î–µ–Ω—å –º–∏—Å—Ç–∏–∫–∏. –°—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏, –±—É–¥—å—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã –∏ —á–µ—Å—Ç–Ω—ã.",
    "5": "–î–µ–Ω—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏ –±–∏–∑–Ω–µ—Å–∞.",
    "6": "–î–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–∞. –î–∞—Ä–∏—Ç–µ –ª—é–±–æ–≤—å, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —É—é—Ç, –∏–∑–±–µ–≥–∞–π—Ç–µ –ª–µ–Ω–∏.",
    "7": "–î–µ–Ω—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Ç–µ–ª–∞ (—Ö–æ–¥—å–±–∞), –º–µ–¥–∏—Ç–∞—Ü–∏—è. –ù–µ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.",
    "8": "–î–µ–Ω—å —Ç—Ä—É–¥–∞. –£—á–∏—Ç–µ—Å—å –∏ —Ä–∞–±–æ—Ç–∞–π—Ç–µ. –ö—Ä–µ–¥–∏—Ç—ã –±—Ä–∞—Ç—å –Ω–µ–ª—å–∑—è.",
    "9": "–î–µ–Ω—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏. –ü–æ–º–æ—â—å –ª—é–¥—è–º, –±–∞–Ω—è, –º–∞—Å—Å–∞–∂. –û—Ç–¥–∞–≤–∞–π—Ç–µ –¥–æ–ª–≥–∏."
}

# --- –õ–û–ì–ò–ö–ê ---
def reduce9(n):
    while n > 9: n = sum(map(int, str(n)))
    return n

# --- –¢–ê–ë–õ–ò–¶–ê (–í–ê–® –§–û–†–ú–ê–¢) ---
def sync_user(update: Update, birth=None, last_ym=None):
    try:
        user = update.effective_user
        uid = str(user.id)
        creds = Credentials.from_service_account_info(json.loads(base64.b64decode(GOOGLE_SA_JSON_B64)), 
                scopes=["https://www.googleapis.com/auth/spreadsheets"])
        ws = gspread.authorize(creds).open_by_key(GSHEET_ID).worksheet("subscriptions")
        
        data = ws.get_all_values()
        idx = next((i for i, r in enumerate(data) if r[0] == uid), -1)
        now = datetime.now(pytz.timezone("Asia/Almaty")).strftime("%d.%m.%Y %H:%M")

        if idx == -1:
            row = [uid, "active", "trial", (datetime.now()+timedelta(days=3)).strftime("%d.%m.%Y"), 
                   birth or "", now, now, user.username or "", user.first_name or "", 
                   user.last_name or "", datetime.now().strftime("%d.%m.%Y"), last_ym or "", "Asia/Almaty", ""]
            ws.append_row(row)
            return row
        else:
            idx += 1
            ws.update_cell(idx, 7, now) # last_seen_at
            if birth: ws.update_cell(idx, 5, birth)
            if last_ym: ws.update_cell(idx, 12, last_ym)
            return ws.row_values(idx)
    except Exception as e:
        log.error(f"Table Error: {e}"); return None

# --- –•–ï–ù–î–õ–ï–†–´ ---
async def start(u: Update, c: ContextTypes.DEFAULT_TYPE):
    sync_user(u)
    await u.message.reply_text("‚ú® –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì), —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –°—é—Ü–∞–π:",
        reply_markup=ReplyKeyboardMarkup([[KeyboardButton("üìÖ –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑")]], resize_keyboard=True))

async def handle_msg(u: Update, c: ContextTypes.DEFAULT_TYPE):
    text, uid = u.message.text.strip(), u.effective_user.id
    if len(text) == 10 and "." in text:
        sync_user(u, birth=text)
        await u.message.reply_text(f"‚úÖ –î–∞—Ç–∞ {text} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –ù–∞–∂–º–∏—Ç–µ '–ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑'.")
        return

    if text == "üìÖ –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑":
        user = sync_user(u)
        if not user or not user[4]:
            await u.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è!"); return
        
        # –†–∞—Å—á–µ—Ç
        bd = datetime.strptime(user[4], "%d.%m.%Y")
        now = datetime.now(pytz.timezone("Asia/Almaty"))
        lg = reduce9(bd.day + bd.month + now.year)
        lm = reduce9(lg + now.month)
        ld = reduce9(lm + now.day)
        od = reduce9(now.day + now.month + now.year)
        ym_key = now.strftime("%m.%Y")

        is_full = (user[11] != ym_key)
        msg = f"üìÖ *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {now.strftime('%d.%m.%Y')}*\n\n"

        # –û–±—â–∏–π –¥–µ–Ω—å (–∏–∑ –û–î.csv)
        if now.day in [10, 20, 30]:
            msg += "‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ!* 10, 20, 30 —á–∏—Å–ª–∞ ‚Äî –Ω–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –¥–∞—Ç—ã. –†–∏—Å–∫ –æ–±–Ω—É–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.\n\n"
        elif od in [3, 6]:
            msg += f"üåü *–û–±—â–∏–π –¥–µ–Ω—å {od}:* –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Å–¥–µ–ª–æ–∫, –±—Ä–∞–∫–∞ –∏ –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π!\n\n"
        else:
            msg += f"üåê *–û–±—â–∏–π –¥–µ–Ω—å:* {od}\n\n"

        # –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–õ–ì –∏ –õ–ú)
        if is_full:
            data_lg = DESC_LG.get(str(lg), {})
            msg += f"‚ú® *–õ–∏—á–Ω—ã–π –≥–æ–¥ {lg}:*\n{data_lg.get('desc','')}\n\n*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:* {data_lg.get('rec','')}\n*–í –º–∏–Ω—É—Å:* {data_lg.get('minus','')}\n\n"
            msg += f"üåô *–õ–∏—á–Ω—ã–π –º–µ—Å—è—Ü {lm}:*\n{DESC_LM.get(str(lm), '–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞...')}\n\n"
            sync_user(u, last_ym=ym_key)
        else:
            msg += "_–§–æ–∫—É—Å –≥–æ–¥–∞ –∏ –º–µ—Å—è—Ü–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –±—ã–ª–∏ 1-–≥–æ —á–∏—Å–ª–∞)._\n\n"

        msg += f"üìç *–õ–∏—á–Ω—ã–π –¥–µ–Ω—å {ld}:*\n{DESC_LD.get(str(ld), '–û–ø–∏—Å–∞–Ω–∏–µ –¥–Ω—è...')}"
        await u.message.reply_text(msg, parse_mode="Markdown")

# --- –°–ï–†–í–ï–† ---
app = Flask(__name__)
application = Application.builder().token(TELEGRAM_TOKEN).build()
application.add_handler(CommandHandler("start", start))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_msg))


@app.route("/webhook", methods=["POST"])
def webhook():
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è Flask –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞"""
    if request.method == "POST":
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            update_data = request.get_json(force=True)
            update = Update.de_json(update_data, application.bot)
            
            # –°–æ–∑–¥–∞–µ–º –ù–û–í–´–ô —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            try:
                # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                loop.run_until_complete(application.process_update(update))
            finally:
                loop.close()
                
        except Exception as e:
            log.error(f"–û—à–∏–±–∫–∞ –≤ –≤–µ–±—Ö—É–∫–µ: {e}")
            
    return "OK", 200

# --- –ë–õ–û–ö –ó–ê–ü–£–°–ö–ê ---

if __name__ == "__main__":
    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞ (—Å–æ–∑–¥–∞–µ–º webhook –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Telegram)
    async def setup_bot():
        await application.initialize()
        await application.start()
        await application.bot.set_webhook(f"{PUBLIC_URL}/webhook")
        log.info("Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–æ–≤—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    setup_loop = asyncio.new_event_loop()
    asyncio.set_event_loop(setup_loop)
    setup_loop.run_until_complete(setup_bot())
    setup_loop.close()

    # 2. –ó–∞–ø—É—Å–∫–∞–µ–º Flask
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)