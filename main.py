import os, json, base64, logging, asyncio
from datetime import datetime, timedelta
import pytz
from flask import Flask, request
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters
import gspread
from google.oauth2.service_account import Credentials

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
PUBLIC_URL = os.getenv("PUBLIC_URL", "").rstrip('/')
GSHEET_ID = os.getenv("GSHEET_ID")
GOOGLE_SA_JSON_B64 = os.getenv("GOOGLE_SA_JSON_B64")

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• –¢–ï–ö–°–¢–û–í (–ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–û –ò–ó CSV) ---
DESC_LG = {
    "1": {"n": "–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞", "d": "–í—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ 9 –ª–µ—Ç. –ü—Ä–∏—Ö–æ–¥–∏—Ç —Å–∞–º—ã–π –º–æ—â–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫.", "r": "–û—Ç–∫—Ä—ã–≤–∞–π –¥–µ–ª–æ, —Ä–∞–∑–≤–∏–≤–∞–π –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, –±–µ—Ä–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.", "m": "–ñ–∂–µ–Ω–∏–µ –≤ —Å–µ—Ä–¥—Ü–µ, –¥–µ–ø—Ä–µ—Å—Å–∏—è, –ø—É—Å—Ç–æ—Ç–∞."},
    "2": {"n": "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π", "d": "–ü–µ—Ä–∏–æ–¥ –ø–µ—Ä–µ–º–µ–Ω. –°—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏ –º–æ–≥—É—Ç —Ä–∞–∑—Ä—É—à–∞—Ç—å—Å—è ‚Äî –Ω–µ —Ü–µ–ø–ª—è–π—Å—è.", "r": "–£—á–∏—Å—å –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏, —Å–æ—Ö—Ä–∞–Ω—è–π –≥–∏–±–∫–æ—Å—Ç—å, –æ—Ç–ø—É—Å–∫–∞–π —Å—Ç–∞—Ä–æ–µ.", "m": "–ë–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã, –¥–µ–ø—Ä–µ—Å—Å–∏—è."},
    "3": {"n": "–ê–Ω–∞–ª–∏–∑ –∏ —É—Å–ø–µ—Ö", "d": "–ü—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ. –í—Ä–µ–º—è —É—Å–ø–µ—Ö–∞ —á–µ—Ä–µ–∑ —Ä–∞—Å—á–µ—Ç.", "r": "–î–µ–π—Å—Ç–≤—É–π —á–µ—Ä–µ–∑ —Ä–∞—Å—á–µ—Ç, –ø–ª–∞–Ω–∏—Ä—É–π —à–∞–≥–∏ –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä–µ–¥.", "m": "–õ–µ–Ω—å, –∞–∑–∞—Ä—Ç, –∫–æ—Ä—ã—Å—Ç—å."},
    "4": {"n": "–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è", "d": "–ì–æ–¥ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–µ–π —á–µ—Ä–µ–∑ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å.", "r": "–°—Ç–∞–≤—å —Ü–µ–ª–∏, –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º, —Ç—Ä—É–¥–∏—Å—å —á–µ—Å—Ç–Ω–æ.", "m": "–ñ–µ–ª–∞–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–∞—Ç—å, —Ä–∏—Å–∫ —Å—É–¥–µ–±–Ω—ã—Ö –¥–µ–ª."},
    "5": {"n": "–£–¥–∞—á–∞ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ", "d": "–ì–æ–¥ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –∏ —Ñ–æ—Ä—Ç—É–Ω—ã. –í—Ä–µ–º—è —Ä–∞—Å—à–∏—Ä—è—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã.", "r": "–†–∞—Å—à–∏—Ä—è–π –±–∏–∑–Ω–µ—Å, –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–π, —Å—Ç—Ä–æ–π —Å–≤—è–∑–∏.", "m": "–ë–æ—Ä—å–±–∞ –∑–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º."},
    "6": {"n": "–£—Å–ø–µ—Ö –∏ –∫–æ–º—Ñ–æ—Ä—Ç", "d": "–í—Ä–µ–º—è –ª—é–±–≤–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –∏ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π.", "r": "–î–∞—Ä–∏ –ª—é–±–æ–≤—å, –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π, —Å–æ–∑–¥–∞–≤–∞–π –∫–æ–º—Ñ–æ—Ä—Ç.", "m": "–ú—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ª–µ–Ω—å, –¥–æ–ª–≥–∏."},
    "7": {"n": "–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∫—Ä–∏–∑–∏—Å", "d": "–û—Ç—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–º—ã. –í—Ä–µ–º—è –≥–ª—É–±–æ–∫–æ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–æ—Å—Ç–∞.", "r": "–ü—Ä–∏–Ω–∏–º–∞–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –±–æ–ª—å—à–µ –¥–≤–∏–≥–∞–π—Å—è, –Ω–µ –Ω–∞—á–∏–Ω–∞–π –Ω–æ–≤–æ–≥–æ.", "m": "–•–∞–æ—Å, –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –æ—Ç—á–∞—è–Ω–∏–µ."},
    "8": {"n": "–¢—Ä—É–¥ –∏ –æ–±—É—á–µ–Ω–∏–µ", "d": "–£—Å–ø–µ—Ö —á–µ—Ä–µ–∑ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É. –í—Ä–µ–º—è –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞.", "r": "–£—á–∏—Å—å, —Ç—Ä—É–¥–∏—Å—å, –ø–æ–∫—É–ø–∞–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å. –ù–µ –±–µ—Ä–∏ –∫—Ä–µ–¥–∏—Ç—ã.", "m": "–£—Å—Ç–∞–ª–æ—Å—Ç—å, –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ."},
    "9": {"n": "–°–ª—É–∂–µ–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ", "d": "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–∞. –ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤.", "r": "–ü—Ä–æ—Å—Ç–∏ –æ–±–∏–¥—ã, –æ—Ç–¥–∞–π —Å—Ç–∞—Ä–æ–µ, –ø–æ–º–æ–≥–∞–π –ª—é–¥—è–º.", "m": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏, —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ."}
}

DESC_LM = {
    "1": {"n": "–•–æ—Ä–æ—à–∏–π –º–µ—Å—è—Ü –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–µ–ª", "d": "–í–∞–∂–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ. –í—Ä–µ–º—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.", "m": "–≠–≥–æ–∏–∑–º, –¥–µ—Å–ø–æ—Ç–∏–∑–º, –∞–≤–∞–Ω—Ç—é—Ä–∏–∑–º."},
    "2": {"n": "–ú–µ—Å—è—Ü –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏", "d": "–ê–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ü–µ–π –±–æ–ª—å—à–µ –≤–æ–¥—ã.", "m": "–ú–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–æ–º–Ω–µ–Ω–∏—è, –¥–µ–ø—Ä–µ—Å—Å–∏—è."},
    "3": {"n": "–ú–µ—Å—è—Ü –∞–Ω–∞–ª–∏–∑–∞ –∏ —É—Å–ø–µ—Ö–∞", "d": "–°–Ω–∞—á–∞–ª–∞ –¥—É–º–∞–π, –ø–æ—Ç–æ–º –¥–µ–ª–∞–π. –•–æ—Ä–æ—à–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è.", "m": "–ö–æ—Ä—ã—Å—Ç—å, –ª–µ–Ω—å, –∞–∑–∞—Ä—Ç."},
    "4": {"n": "–ú–µ—Å—è—Ü –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π", "d": "–°—Ç–∞–≤—å —Ü–µ–ª–∏, –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–µ–Ω –∏ —á–µ—Å—Ç–µ–Ω.", "m": "–û–±–∏–¥—á–∏–≤–æ—Å—Ç—å, –ø–∞–Ω–∏–∫–∞, –ø–æ—Ç–µ—Ä—è –ª–æ–≥–∏–∫–∏."},
    "5": {"n": "–ú–µ—Å—è—Ü –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è", "d": "–í—Ä–µ–º—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –ø–æ–µ–∑–¥–æ–∫ –∏ –Ω–æ–≤—ã—Ö —Å–≤—è–∑–µ–π.", "m": "–ù–µ–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ, —ç–∫—Å—Ç—Ä–µ–º–∏–∑–º."},
    "6": {"n": "–ú–µ—Å—è—Ü –ª—é–±–≤–∏ –∏ —É—Å–ø–µ—Ö–∞", "d": "–ò–Ω—Ç—É–∏—Ü–∏—è –Ω–∞ –¥–µ–Ω—å–≥–∏. –£–¥–∞—á–Ω–æ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.", "m": "–ò–∑–ª–∏—à–µ—Å—Ç–≤–∞, –º—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å."},
    "7": {"n": "–ú–µ—Å—è—Ü —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏", "d": "–ñ–∏–∑–Ω—å –≤ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ. –ü–æ–ª–µ–∑–Ω—ã –π–æ–≥–∞ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏.", "m": "–•–∞–æ—Å, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å—Ä—ã–≤—ã."},
    "8": {"n": "–ú–µ—Å—è—Ü —Ç—Ä—É–¥–∞ –∏ –æ–±—É—á–µ–Ω–∏—è", "d": "–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π —Ñ–∏–Ω–∞–Ω—Å—ã, –ø–æ–≤—ã—à–∞–π –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é.", "m": "–ß—Ä–µ–∑–º–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –Ω–µ–¥–æ–≤–µ—Ä–∏–µ."},
    "9": {"n": "–ú–µ—Å—è—Ü –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏", "d": "–ü–æ–¥–≤–æ–¥–∏ –∏—Ç–æ–≥–∏ –∏ –æ—Ç–ø—É—Å–∫–∞–π –ª–∏—à–Ω–µ–µ.", "m": "–í–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —ç–º–æ—Ü–∏–∏."}
}

DESC_LD = {
    "1": "–î–µ–Ω—å –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π. –†–µ–∞–ª–∏–∑—É–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –±—É–¥—å —Å–º–µ–ª—ã–º.",
    "2": "–î–µ–Ω—å –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –°–ª—É—à–∞–π –∏—Å–∫—Ä–µ–Ω–Ω–µ, –Ω–∞–ª–∞–∂–∏–≤–∞–π —Å–≤—è–∑–∏.",
    "3": "–î–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ò–∑–±–µ–≥–∞–π –∞–∑–∞—Ä—Ç–∞.",
    "4": "–î–µ–Ω—å –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π. –ë—É–¥—å —á–µ—Å—Ç–µ–Ω, —Å—Ç–∞–≤—å —Ü–µ–ª–∏.",
    "5": "–î–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –û—Ç–ª–∏—á–Ω–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏ —Å–≤—è–∑–µ–π.",
    "6": "–î–µ–Ω—å —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ –ª—é–±–≤–∏. –°–æ–∑–¥–∞–≤–∞–π –∫–æ–º—Ñ–æ—Ä—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö.",
    "7": "–î–µ–Ω—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏. –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Ç–µ–ª–∞ (—Ö–æ–¥—å–±–∞).",
    "8": "–î–µ–Ω—å –æ–±—É—á–µ–Ω–∏—è –∏ —Ç—Ä—É–¥–∞. –ü–æ–ª—É—á–∞–π –Ω–∞–≤—ã–∫–∏, –Ω–µ –±–µ—Ä–∏ –∫—Ä–µ–¥–∏—Ç—ã.",
    "9": "–î–µ–Ω—å –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏. –ü–æ–º–æ–≥–∞–π –ª—é–¥—è–º, –æ—Ç–¥–∞–≤–∞–π –¥–æ–ª–≥–∏."
}

# --- –õ–û–ì–ò–ö–ê ---
def reduce9(n):
    while n > 9: n = sum(map(int, str(n)))
    return n

def sync_user(update, birth=None, last_ym=None):
    try:
        user = update.effective_user
        uid = str(user.id)
        creds_json = json.loads(base64.b64decode(GOOGLE_SA_JSON_B64).decode("utf-8"))
        creds = Credentials.from_service_account_info(creds_json, scopes=["https://www.googleapis.com/auth/spreadsheets"])
        ws = gspread.authorize(creds).open_by_key(GSHEET_ID).worksheet("subscriptions")
        
        data = ws.get_all_values()
        idx = next((i for i, r in enumerate(data) if r[0] == uid), -1)
        now_ts = datetime.now(pytz.timezone("Asia/Almaty")).strftime("%d.%m.%Y %H:%M")

        if idx == -1:
            row = [
                uid, "active", "trial", (datetime.now() + timedelta(days=3)).strftime("%d.%m.%Y"),
                birth or "", now_ts, now_ts, user.username or "", user.first_name or "",
                user.last_name or "", datetime.now().strftime("%d.%m.%Y"), last_ym or "", "Asia/Almaty", ""
            ]
            ws.append_row(row)
            return row
        else:
            idx += 1
            ws.update_cell(idx, 7, now_ts)
            if birth: ws.update_cell(idx, 5, birth)
            if last_ym: ws.update_cell(idx, 12, last_ym)
            return ws.row_values(idx)
    except Exception as e:
        log.error(f"GSheet Error: {e}"); return None

# --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–ì–ù–û–ó–ê ---
async def send_full_forecast(u: Update, user_row):
    try:
        bd_str = user_row[4]
        bd = datetime.strptime(bd_str, "%d.%m.%Y")
        now = datetime.now(pytz.timezone("Asia/Almaty"))
        
        lg = reduce9(bd.day + bd.month + now.year)
        lm = reduce9(lg + now.month)
        ld = reduce9(lm + now.day)
        od = reduce9(now.day + now.month + now.year)
        
        msg = f"üìÖ *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {now.strftime('%d.%m.%Y')}*\n\n"
        
        # –û–±—â–∏–π –¥–µ–Ω—å
        if now.day in [10, 20, 30]:
            msg += "‚ö†Ô∏è *–ù–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–∞—è –¥–∞—Ç–∞ (10, 20, 30):* –†–∏—Å–∫ –æ–±–Ω—É–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ù–µ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –Ω–æ–≤–æ–µ.\n\n"
        elif od in [3, 6]:
            msg += f"üåü *–û–±—â–∏–π –¥–µ–Ω—å {od}:* –û—á–µ–Ω—å –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Å–¥–µ–ª–æ–∫ –∏ –Ω–∞—á–∏–Ω–∞–Ω–∏–π!\n\n"
        else:
            msg += f"üåê *–û–±—â–∏–π –¥–µ–Ω—å:* {od}\n\n"

        # –ì–æ–¥ –∏ –ú–µ—Å—è—Ü
        i_lg = DESC_LG.get(str(lg), {})
        msg += f"‚ú® *–õ–∏—á–Ω—ã–π –≥–æ–¥ {lg}: {i_lg.get('n','')}*\n{i_lg.get('d','')}\n"
        msg += f"*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* {i_lg.get('r','')}\n*–í –º–∏–Ω—É—Å–µ:* {i_lg.get('m','')}\n\n"
        
        i_lm = DESC_LM.get(str(lm), {})
        msg += f"üåô *–õ–∏—á–Ω—ã–π –º–µ—Å—è—Ü {lm}: {i_lm.get('n','')}*\n{i_lm.get('d','')}\n*–í –º–∏–Ω—É—Å–µ:* {i_lm.get('m','')}\n\n"
        
        # –î–µ–Ω—å
        msg += f"üìç *–õ–∏—á–Ω—ã–π –¥–µ–Ω—å {ld}:*\n{DESC_LD.get(str(ld), '')}"
        
        await u.message.reply_text(msg, parse_mode="Markdown")
    except Exception as e:
        log.error(f"Forecast error: {e}")

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
async def start(u: Update, c: ContextTypes.DEFAULT_TYPE):
    sync_user(u)
    await u.message.reply_text("‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì):",
        reply_markup=ReplyKeyboardMarkup([[KeyboardButton("üìÖ –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑")]], resize_keyboard=True))

async def handle_msg(u: Update, c: ContextTypes.DEFAULT_TYPE):
    text = u.message.text.strip()
    if len(text) == 10 and text.count(".") == 2:
        user_data = sync_user(u, birth=text)
        await u.message.reply_text(f"‚úÖ –î–∞—Ç–∞ {text} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –í–æ—Ç –≤–∞—à –ø—Ä–æ–≥–Ω–æ–∑:")
        await send_full_forecast(u, user_data)
        return

    if text == "üìÖ –ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑":
        user_data = sync_user(u)
        if user_data and user_data[4]:
            await send_full_forecast(u, user_data)
        else:
            await u.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è!")

# --- –°–ï–†–í–ï–† ---
app = Flask(__name__)
application = Application.builder().token(TELEGRAM_TOKEN).build()
application.add_handler(CommandHandler("start", start))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_msg))

main_loop = asyncio.get_event_loop()

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        update = Update.de_json(request.get_json(force=True), application.bot)
        asyncio.run_coroutine_threadsafe(application.process_update(update), main_loop)
    except Exception as e:
        log.error(f"Webhook error: {e}")
    return "OK", 200

@app.route("/")
def index(): return "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!", 200

if __name__ == "__main__":
    main_loop.run_until_complete(application.initialize())
    main_loop.run_until_complete(application.bot.set_webhook(f"{PUBLIC_URL}/webhook"))
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 10000)))