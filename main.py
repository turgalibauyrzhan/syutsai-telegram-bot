import os
import json
import base64
import asyncio
import logging
from datetime import datetime, date
import pytz

from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters
import gspread
from google.oauth2.service_account import Credentials
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
PUBLIC_URL = os.getenv("PUBLIC_URL")
GSHEET_ID = os.getenv("GSHEET_ID")
GOOGLE_SA_JSON_B64 = os.getenv("GOOGLE_SA_JSON_B64")
TZ = pytz.timezone("Asia/Almaty")

# --- –î–ê–ù–ù–´–ï –ò–ó –í–ê–®–ò–• –¢–ê–ë–õ–ò–¶ ---
TEXTS_DATA = {
    "unfavorable_day": "‚ö†Ô∏è –ù–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ —Å–æ–±—ã—Ç–∏—è. –ï—Å—Ç—å –≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±–Ω—É–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å –∫—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏, –¥–æ–≥–æ–≤–æ—Ä—ã, –∫—Ä–µ–¥–∏—Ç—ã –∏ —Ç.–¥.",
    "OD": {
        "3": "üåü *–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å (–û–î 3)*\n–î–µ–Ω—å —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∏ —É—Å–ø–µ—Ö. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π, –∫—Ä—É–ø–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫ –∏ –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π.",
        "6": "üíñ *–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å (–û–î 6)*\n–î–µ–Ω—å —á–µ—Ä–µ–∑ –ª—é–±–æ–≤—å –∏ —É—Å–ø–µ—Ö. –•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –±—Ä–∞–∫–∞, –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –∏ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤."
    },
    "LG": {
        "1": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 1. –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞", "d": "–í—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ 9 –ª–µ—Ç. –ú–æ—â–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫.", "r": "–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —Å–≤–æ–µ –¥–µ–ª–æ, —Ä–∞–∑–≤–∏–≤–∞–π—Ç–µ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø–æ–∑–∏—Ç–∏–≤."},
        "2": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 2. –î–∏–ø–ª–æ–º–∞—Ç–∏—è –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è", "d": "–ü–µ—Ä–∏–æ–¥ –ø–µ—Ä–µ–º–µ–Ω –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö. –°—Ç–∞—Ä–æ–µ —É—Ö–æ–¥–∏—Ç, –Ω–æ–≤–æ–µ —Å—Ç—Ä–æ–∏—Ç—Å—è.", "r": "–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –Ω–∞–≤—ã–∫–∏ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏, –±—É–¥—å—Ç–µ –≥–∏–±–∫–∏–º–∏, –æ—Ç–ø—É—Å–∫–∞–π—Ç–µ –ø—Ä–æ—à–ª–æ–µ."},
        "3": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 3. –ê–Ω–∞–ª–∏–∑ –∏ —É—Å–ø–µ—Ö", "d": "–ì–æ–¥ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—ä–µ–º–∞ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ö–æ–ª–æ–¥–Ω—ã–π —Ä–∞—Å—á–µ—Ç.", "r": "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è, –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ, –¥–µ–π—Å—Ç–≤—É–π—Ç–µ —á–µ—Ä–µ–∑ –ª–æ–≥–∏–∫—É."},
        "4": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 4. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω—ã", "d": "–ì–æ–¥ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏ –≥–ª—É–±–æ–∫–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.", "r": "–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω—ã, —Ä–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–æ–π —Ç–µ–ª–∞ –∏ –¥—É—Ö–∞."},
        "5": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 5. –û–±—â–µ–Ω–∏–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "d": "–ú–µ—Å—è—Ü —Å—Ç–∞—Ä—Ç–æ–≤, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–≤—è–∑–µ–π.", "r": "–ë—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤–æ–º—É, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Ä–æ—Å—Ç–∞."},
        "6": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 6. –õ—é–±–æ–≤—å –∏ —É—Å–ø–µ—Ö", "d": "–ì–æ–¥ —Å–µ–º–µ–π–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, –∫–æ–º—Ñ–æ—Ä—Ç–∞ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–ø–ª–∞.", "r": "–£–∫—Ä–µ–ø–ª—è–π—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –ø—Ä–æ—è–≤–ª—è–π—Ç–µ –∑–∞–±–æ—Ç—É, –∑–∞–Ω–∏–º–∞–π—Ç–µ—Å—å —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ–º."},
        "7": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 7. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∫—Ä–∏–∑–∏—Å", "d": "–ì–ª—É–±–∏–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ —Å–æ–±–æ–π, –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.", "r": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—Ä–∏–∑–∏—Å –∫–∞–∫ —Ç–æ—á–∫—É —Ä–æ—Å—Ç–∞, –Ω–µ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –Ω–æ–≤—ã—Ö –¥–µ–ª."},
        "8": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 8. –¢—Ä—É–¥ –∏ –æ–±—É—á–µ–Ω–∏–µ", "d": "–£—Å–ø–µ—Ö —á–µ—Ä–µ–∑ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–∞–≤—ã–∫–æ–≤.", "r": "–¢—Ä—É–¥–∏—Ç–µ—Å—å, –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –∏–∑–±–µ–≥–∞–π—Ç–µ –∫—Ä–µ–¥–∏—Ç–æ–≤."},
        "9": {"t": "–õ–∏—á–Ω—ã–π –≥–æ–¥ 9. –°–ª—É–∂–µ–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ", "d": "–ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ.", "r": "–ü—Ä–æ—â–∞–π—Ç–µ –æ–±–∏–¥—ã, –ø–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥–∏–º, –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –¥–µ–ª–∞."}
    },
    "LM": {
        "1": {"t": "–õ–ú 1. –ú–µ—Å—è—Ü —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏", "d": "–í—Ä–µ–º—è –ª–∏–¥–µ—Ä—Å—Ç–≤–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤."},
        "2": {"t": "–õ–ú 2. –ú–µ—Å—è—Ü –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏", "d": "–†–∞–∑–≤–∏—Ç–∏–µ —á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Å–≤—è–∑–µ–π."},
        "3": {"t": "–õ–ú 3. –ú–µ—Å—è—Ü –∞–Ω–∞–ª–∏–∑–∞", "d": "–°–Ω–∞—á–∞–ª–∞ –¥—É–º–∞–µ–º, –ø–æ—Ç–æ–º –¥–µ–ª–∞–µ–º. –£—Å–ø–µ—Ö –≤ –æ–±—É—á–µ–Ω–∏–∏."},
        "4": {"t": "–õ–ú 4. –ú–µ—Å—è—Ü –º–∏—Å—Ç–∏–∫–∏", "d": "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∫–æ–π."},
        "5": {"t": "–õ–ú 5. –ú–µ—Å—è—Ü —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è", "d": "–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–∞, –ø–æ–µ–∑–¥–æ–∫ –∏ –∏–¥–µ–π."},
        "6": {"t": "–õ–ú 6. –ú–µ—Å—è—Ü —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞", "d": "–ò–Ω—Ç—É–∏—Ü–∏—è –Ω–∞ –¥–µ–Ω—å–≥–∏, —É–¥–∞—á–∞ –≤ –ª—é–±–≤–∏ –∏ –ø–æ–∫—É–ø–∫–∞—Ö."},
        "7": {"t": "–õ–ú 7. –ú–µ—Å—è—Ü –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã", "d": "–õ–∏–±–æ –≤–∑–ª–µ—Ç, –ª–∏–±–æ –ø–∞–¥–µ–Ω–∏–µ. –í–∞–∂–Ω–∞ –π–æ–≥–∞ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏."},
        "8": {"t": "–õ–ú 8. –ú–µ—Å—è—Ü –∫–æ–Ω—Ç—Ä–æ–ª—è", "d": "–í–Ω–∏–º–∞–Ω–∏–µ –∫ –º–µ–ª–æ—á–∞–º, –º—É–¥—Ä–æ—Å—Ç—å –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö."},
        "9": {"t": "–õ–ú 9. –ú–µ—Å—è—Ü –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è", "d": "–û—á–∏—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, –∏–∑–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç —Ö–ª–∞–º–∞."}
    },
    "LD": {
        "1": {"t": "–õ–î 1. –ù–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è", "d": "–õ—é–±–æ–µ –¥–µ–ª–æ –ø–æ–ª—É—á–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É —ç–Ω–µ—Ä–≥–∏–∏ –¥–Ω—è."},
        "2": {"t": "–õ–î 2. –ü–æ–Ω–∏–º–∞–Ω–∏–µ", "d": "–ü—Ä–æ—è–≤–ª—è–π—Ç–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ. –î–µ–Ω—å –¥–ª—è —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π."},
        "3": {"t": "–õ–î 3. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "d": "–ê–Ω–∞–ª–∏–∑ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –≤–µ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è."},
        "4": {"t": "–õ–î 4. –ú–∏—Å—Ç–∏–∫–∞", "d": "–°–æ–±—ã—Ç–∏—è –≤–Ω–µ –ª–æ–≥–∏–∫–∏. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç—Ä–µ–∑–≤—ã–π —É–º."},
        "5": {"t": "–õ–î 5. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏", "d": "–î–µ–Ω—å –æ–±—â–µ–Ω–∏—è, –ø—Ä–æ–¥–∞–∂ –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞–∫–æ–º—Å—Ç–≤."},
        "6": {"t": "–õ–î 6. –ó–∞–±–æ—Ç–∞", "d": "–î–∞—Ä–∏—Ç–µ —Ç–µ–ø–ª–æ –±–ª–∏–∑–∫–∏–º, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–º—Ñ–æ—Ä—Ç."},
        "7": {"t": "–õ–î 7. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è", "d": "–ù–∞—á–Ω–∏—Ç–µ —É—Ç—Ä–æ —Å —Ö–æ–¥—å–±—ã –∏–ª–∏ –º–æ–ª–∏—Ç–≤—ã."},
        "8": {"t": "–õ–î 8. –û–±—É—á–µ–Ω–∏–µ", "d": "–¢—Ä—É–¥ –ø—Ä–∏–Ω–µ—Å–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±—É–¥—É—â–µ–º."},
        "9": {"t": "–õ–î 9. –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å", "d": "–û—Ç–¥–∞–≤–∞–π—Ç–µ –¥–æ–ª–≥–∏, —Å–ª—É–∂–∏—Ç–µ –ª—é–¥—è–º, –æ—á–∏—â–∞–π—Ç–µ—Å—å."}
    }
}

# --- –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê ---
def reduce9(n: int) -> int:
    while n > 9: n = sum(map(int, str(n)))
    return n

def calculate_numerology(bd: date, target_date: date):
    od = reduce9(target_date.day + target_date.month + target_date.year)
    lg = reduce9(bd.day + bd.month + target_date.year)
    lm = reduce9(lg + target_date.month)
    ld = reduce9(lm + target_date.day)
    return od, lg, lm, ld

# --- GOOGLE SHEETS ---
def get_sheet():
    sa_info = json.loads(base64.b64decode(GOOGLE_SA_JSON_B64).decode("utf-8"))
    creds = Credentials.from_service_account_info(sa_info, scopes=["https://www.googleapis.com/auth/spreadsheets"])
    gc = gspread.authorize(creds)
    return gc.open_by_key(GSHEET_ID).worksheet("subscriptions")

def upsert_user(data):
    ws = get_sheet()
    rows = ws.get_all_records()
    for i, r in enumerate(rows, start=2):
        if str(r.get("telegram_user_id")) == str(data["telegram_user_id"]):
            ws.update(f"A{i}:L{i}", [[data.get(h, "") for h in ws.row_values(1)]])
            return
    ws.append_row([data.get(h, "") for h in ws.row_values(1)])

# --- –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ---
def build_message(bd_str: str):
    today = datetime.now(TZ).date()
    bd = datetime.strptime(bd_str, "%d.%m.%Y").date()
    od, lg, lm, ld = calculate_numerology(bd, today)
    
    msg = f"üìÖ *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {today.strftime('%d.%m.%Y')}*\n\n"
    
    # –û–±—â–∏–π –¥–µ–Ω—å
    if today.day in {10, 20, 30}:
        msg += f"{TEXTS_DATA['unfavorable_day']}\n\n"
    elif str(od) in TEXTS_DATA["OD"]:
        msg += f"{TEXTS_DATA['OD'][str(od)]}\n\n"
    else:
        msg += f"üåê *–û–±—â–∏–π –¥–µ–Ω—å:* {od}\n\n"

    # –õ–∏—á–Ω—ã–π –ì–æ–¥
    g = TEXTS_DATA["LG"][str(lg)]
    msg += f"‚ú® *{g['t']}*\n_{g['d']}_\nüí° {g['r']}\n\n"
    
    # –õ–∏—á–Ω—ã–π –ú–µ—Å—è—Ü
    m = TEXTS_DATA["LM"][str(lm)]
    msg += f"üåô *{m['t']}*\n{m['d']}\n\n"
    
    # –õ–∏—á–Ω—ã–π –î–µ–Ω—å
    d = TEXTS_DATA["LD"][str(ld)]
    msg += f"üìç *{d['t']}*\n{d['d']}"
    
    return msg

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    text = update.message.text.strip()
    
    if "." in text: # –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É
        try:
            datetime.strptime(text, "%d.%m.%Y")
            user_data = {"telegram_user_id": uid, "birth_date": text, "last_seen_at": datetime.now(TZ).isoformat()}
            upsert_user(user_data)
            await update.message.reply_text(build_message(text), parse_mode="Markdown", 
                                            reply_markup=ReplyKeyboardMarkup([["–°–µ–≥–æ–¥–Ω—è"]], resize_keyboard=True))
        except:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì")
    elif text == "–°–µ–≥–æ–¥–Ω—è":
        # –ó–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∞—Ç—å –¥–∞—Ç—É –∏–∑ –±–∞–∑—ã, –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ —Å–Ω–æ–≤–∞ –µ—Å–ª–∏ –Ω–µ—Ç –≤ –ø–∞–º—è—Ç–∏
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.")

# --- –ó–ê–ü–£–°–ö ---
application = Application.builder().token(TELEGRAM_TOKEN).build()
application.add_handler(CommandHandler("start", start))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

if __name__ == "__main__":
    application.run_webhook(
        listen="0.0.0.0",
        port=int(os.environ.get("PORT", 8080)),
        webhook_url=f"{PUBLIC_URL}/webhook"
    )