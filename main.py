# -*- coding: utf-8 -*-
import os, re, json, base64, logging
from datetime import datetime, timedelta, date, time
from zoneinfo import ZoneInfo
from typing import Any, Dict, Optional, List, Tuple

from telegram import Update
from telegram.constants import ParseMode
from telegram import ReplyKeyboardMarkup, KeyboardButton
from telegram.error import Conflict
from telegram.ext import (
    Application, CommandHandler, MessageHandler, ConversationHandler,
    ContextTypes, filters
)

# Optional Google Sheets
try:
    import gspread
    from google.oauth2.service_account import Credentials
except Exception:
    gspread = None
    Credentials = None

# ---------------- Logging ----------------
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO").upper()
logging.basicConfig(level=LOG_LEVEL, format="%(asctime)s - syucai - %(levelname)s - %(message)s")
log = logging.getLogger("syucai")

TZ = ZoneInfo("Asia/Almaty")

TOKEN = (os.getenv("TELEGRAM_BOT_TOKEN") or "").strip()
if not TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN is not set (Render env var).")

GSHEET_ID = (os.getenv("GSHEET_ID") or "").strip()
SUBS_SHEET_NAME = (os.getenv("SUBS_SHEET_NAME") or "subscriptions").strip() or "subscriptions"

ADMIN_IDS: List[int] = []
_raw_admin = (os.getenv("ADMIN_IDS") or "").strip()
if _raw_admin:
    for x in re.split(r"[ ,;]+", _raw_admin):
        if x.isdigit():
            ADMIN_IDS.append(int(x))

SUBS_COLUMNS = [
    "telegram_user_id","status","plan","trial_expires","birth_date","created_at",
    "last_seen_at","username","first_name","last_name","registered_on","last_full_ym"
]

# ---------------- Interpretations (from your docx) ----------------
PERSONAL_YEAR = json.loads(r'''{"1": {"short": "Личный год 1. Начало нового цикла.", "full": "Это время выбора направления, в котором ты хочешь реализоваться в ближайшие 9 лет. Именно сейчас приходит самый мощный энергетический поток за весь цикл.\nРекомендации:\n– Отличный период для открытия собственного дела или запуска нового проекта.\n– Определи для себя одно ключевое направление и сосредоточься на нем, не распыляясь.\n– Развивай лидерские качества и учись брать ответственность на себя.\n– Старайся сохранять внутренний позитивный настрой: тогда энергия будет работать на результат.\nЕсли энергия года не используется:\nМожет ощущаться жжение в области сердечной чакры, появляться депрессивное состояние и чувство пустоты от непонимания, куда направить этот мощный поток."}, "2": {"short": "Личный год 2. Год построения отношений и дипломатии.", "full": "Этот период связан с подвижностью и переменами в отношениях. Не стоит принимать кардинальных решений: многое будет меняться само. Старые связи могут разрушаться — важно не цепляться за них, а мягко отпускать и строить новые. Возможны сомнения, колебания и поиск более выгодных взаимодействий во всех сферах.\nРекомендации:\n – Учись строить новые связи и развивай навыки дипломатии.\n – Поддерживай и укрепляй существующие отношения, несмотря на трудности.\n – Позволь старому уйти, чтобы появилось место для нового.\n – В отношениях сохраняй гибкость и «оставляй двери открытыми».\n – Смотри на людей и ситуации реалистично, избегая иллюзий.\nЕсли энергия года не используется:\nВозможны депрессия и болезненные переживания, связанные с разрывом отношений."}, "3": {"short": "Личный год 3. Год анализа и успеха.", "full": "В этот период пробуждается аналитическое мышление: человек начинает планировать, подводить итоги и более осознанно подходить к своим действиям. Это время планирования и ведения учета.\nРекомендации:\n– Действуй через анализ и расчет.\n– В бизнесе и совместных делах выстраивай справедливое и прозрачное управление.\n– Планируй шаги на день, месяц и год вперед.\n– Подводи промежуточные итоги, корректируй и обновляй планы по мере необходимости.\n – Следи за своим временем: куда оно уходит и какие результаты приносит.\nЕсли энергия года не используется:\nМогут проявляться лень, азарт, корысть и стремление к быстрой выгоде. В итоге это приводит к разрушению планов и потере ресурсов."}, "4": {"short": "Личный год 4. Год трансформации и постановки целей.", "full": "Этот период идеально подходит для формирования желаний, постановки задач и определения долгосрочных целей. Возможны мистические события положительного характера: неожиданные подарки, везение, удачные совпадения. Это время реализации креативных идей.\nРекомендации:\n– Мысли позитивно, чтобы энергия шла на реализацию креатива, а не на разрушение.\n– Все дела, связанные с документами, договорами, покупкой или продажей, тщательно проверяй — особенно мелкий шрифт.\n– Работай со своими целями регулярно: анализируй их, корректируй, обновляй и формируй новые.\n– Учись расставлять приоритеты и держать фокус на главном.\nЕсли энергия года не используется:\nВозможны неожиданные мистические события негативного характера, усиление страхов, желание разрушать, вплоть до отношений. Может возникнуть потеря контроля над ситуацией."}, "5": {"short": "Личный год 5. Год коммуникации и масштабирования.", "full": "В этот период всё тайное становится явным: человеку открываются события и факты, которые раньше оставались невидимыми. Это время активных коммуникаций, расширения круга знакомств и формирования качественного окружения. Год благоприятен для публичности: можно заявлять о себе, выступать, делиться проектами и продвигать личный бренд, который будет работать на тебя в долгосрочной перспективе.\nРекомендации:\n– Заводи новые знакомства и укрепляй связи.\n– Используй время для продвижения собственного бренда и самопрезентации.\n– Выступай, делись знаниями, не бойся заявлять о себе.\n– Сохраняй логичность и последовательность в действиях — это твоя сила в этом году.\nЕсли энергия года не используется:\nМожет разрушаться логика под давлением вскрывшейся информации. Возникает стремление спорить, доказывать, действовать наперекор — это приводит к потере энергии и внутренним конфликтам."}, "6": {"short": "Личный год 6. Год любви и успеха.", "full": "Это время, когда успех словно идёт впереди тебя, открывая возможности. Год связан с любовью, гармонией и проверкой истинных ценностей. Всё, чем делишься от сердца, возвращается с избытком.\nРекомендации:\n– Щедро делись любовью и теплом — они вернутся многократно.\n– Ставь глобальные цели: в этом году возможно исполнение мечтаний.\n– Испытывай и выражай эмоции любви, но избегай излишеств.\n– Не гонись за мимолётными удовольствиями и не поддавайся желаниям, которые ведут к страданиям.\n– Пересмотри ценности: время отсеивает низкие вибрации и всё лишнее.\nЕсли энергия года не используется:\nВозможны обострения хронических заболеваний — как физических, так и психических. Неразборчивые связи и излишества могут привести к болезням, потерям и долгам."}, "7": {"short": "Личный год 7. Год трансформации и кризиса.", "full": "Это лучшее время для глубокой внутренней трансформации, развития и понимания причинно-следственных связей. Год связан с отработкой кармы и переосмыслением жизненного опыта.\nРекомендации:\n– Принимай ответственность за происходящее, не перекладывай вину на других и не погружайся в страдания.\n– Если наступает кризис, используй его как точку роста и трансформации.\n– Не начинай новое дело: в этом году сложно трезво анализировать финансы.\n– Избегай операций с недвижимостью (покупки, продажи, оформления).\n– Работай над подъемом энергии, уделяй внимание духовным практикам.\n– Больше двигайся и ходи пешком — это поддержит энергию и ясность ума.\nЕсли энергия года не используется:\nМожет появиться хаос, непонимание, отчаяние, рассеянность и болезненное переживание кризиса."}, "8": {"short": "Личный год 8. Год труда и обучения.", "full": "Это время, когда успех достигается через обучение, труд и дисциплину. Всё, что ты наработаешь в этом году, будет служить тебе долгие годы.\nРекомендации:\n– Учись, трудись, приобретай новые навыки — они станут прочным фундаментом на всю жизнь.\n– Хороший год для покупки и продажи недвижимости.\n– Избегай кредитов, даже для расширения бизнеса.\n– Инвестируй в образование и профессиональное развитие, а не в развлечения.\n– Не заключай браки в этот период: высок риск расторжения через 10–15 лет.\nЕсли энергия года не используется:\nЧеловек может попасть в зону ограничений, страдать от усталости и перегрузки. Либо, наоборот, возникает стремление уйти в бездействие, тунеядство и постоянные развлечения."}, "9": {"short": "Личный год 9. Год служения и разрушения.", "full": "Это время подведения итогов и освобождения от всего ненужного. Всё, что имеет начало, имеет и конец — это естественный закон жизни. Завершение одного периода означает освобождение пространства для нового.\nРекомендации:\n– Позволь уйти всему устаревшему: знаниям, убеждениям, связям.\n– Прости обиды и распрощайся с тем, что больше не актуально.\n– Удели внимание здоровью: спорт, профилактика, чекапы.\n– Принимай происходящее и людей с благодарностью.\n– Больше служи, помогай, отдавай — так энергия будет работать во благо.\n– Подготовь себя и своё здоровье к новому циклу.\nЕсли энергия года не используется:\nВозникает непонимание и раздражение из-за потерь. Возможны вспыльчивость, чрезмерная эмоциональность, ярость и попытки удержать то, что должно уйти.\nЛичные месяцы:\nЛичный месяц 1. Хороший месяц для начала дел.\nВ этом месяце важно посвятить себя стратегии и планированию. Благоприятный период для проявления лидерских качеств, повышения оптимизма и идеализма. Усиливаются качества оратора и психическая энергия влияния на людей. Хорошее время для начала новых проектов и стремления быть первым везде и во всём. Рекомендуется развивать личную ответственность и укреплять внутреннюю дисциплину.\nВ минусе проявляется сильный эгоизм, деспотизм и жажда подавления других. Возможны ошибочные и необдуманные действия. Могут проявиться такие качества, как самодурство, упрямство и твердолобие. В поступках может присутствовать авантюризм.\nЛичный месяц 2. Месяц дипломатии и выстраивания отношений.\nПоявляется больше реалистичности и стремления докопаться до сути. Активизируется энергия воспоминаний, усиливается чувственность. Во всём важно проявлять дипломатию. Серьёзные решения лучше отложить до следующего месяца. Полезно пить больше воды.\nМожет проявляться медлительность, сомнения, усиление депрессивных состояний. Мысли и действия часто направлены на разрыв отношений. Усиливается желание манипулировать.\nЛичный месяц 3. Месяц анализа и успеха.\nДействовать через анализ: сначала думать, потом делать. Усиливается стремление к справедливости и заботе. Возникает желание учиться — это хороший период для экзаменов и медицинских процедур. Благоприятно структурировать дела и планы, анализировать каждый день и действовать по плану. Месяц особенно удачен для свадьбы.\nВ минусе проявляется лень, азарт и необдуманные шаги могут привести к потерям и разрушениям. Возможны упрямство, категоричность, чрезмерный контроль, требовательность, пустословие и нежелание учиться.\nЛичный месяц 4. Месяц мистических событий, как положительных, так и отрицательных.\nПосвятить месяц работе с целями. Важно всё упорядочить, структурировать, детализировать и четко спланировать. Будут появляться новые идеи и задачи. Усилится креатив, захочется новизны. Интуиция станет острее. Возможны неожиданные позитивные события и подарки судьбы.\nВ минусе проявляется апатия, желание разрушить то, что уже создано, в надежде на лучшее. Могут происходить отрицательные события мистического характера. Усилится стремление нарушать систему, правила и инструкции. В голове могут возникать мошеннические схемы. Появляется чувство неудовлетворенности и иллюзия, что с вами поступили нечестно.\nЛичный месяц 5. Месяц коммуникаций и перемен.\nУсиливается фарт и везение. Ум работает на рационализаторство и улучшения, логика становится сильнее. Растёт чувство эстетики, стиля и красоты. Легко подстраиваться под собеседника. Усиливается желание начать новый бизнес или проект. Благоприятно посвятить месяц разработке идей, дизайну, упаковке. Приходит энергия расширения и приумножения. Тянет к поездкам, путешествиям, шопингу, захочется что-то увеличить и развить.\nВ минусе проявляется повышенная обидчивость и ранимость. Может отключиться везение, усиливаться чувство паники и страха. События будут ограничивать свободу. Логика постоянно будет подвергаться ударам: люди ведут себя нелогично и неправильно. По отношению к другим возможны холодность, расчётливость, жёсткость, а местами даже жестокость. Возможно, личные тайны станут публичными или вскроется то, чего вы не знали. Участятся споры и несогласия, появится желание всё делать только с пользой для себя.\nЛичный месяц 6. Месяц любви и успеха.\nПериод творчества и удачи. Возникает сильное желание действовать творчески, начать творческий проект или заняться искусством. Это время удачи, везения, богатства. Усиливается интуиция на деньги. Проявляется мудрость в мыслях и действиях. Повышается чувственность, тактильность и общительность. Важно всё делать с любовью и через творчество. Благоприятный период для бракосочетания, инвестиций, вложений и крупных покупок.\nВ минусе проявляется высокая эмоциональность, нежелание учиться, стремление к комфорту и излишествам. Может возникнуть соблазн заработать нечестным путём. Появляются мстительные сценарии в мыслях. Возможны болезни и обострения хронических заболеваний.\nЛичный месяц 7. Месяц кризиса или осознанной трансформации.\nВажно жить в дисциплине, тщательно продумывать все свои действия и мысли до конца. В этот период нет золотой середины: или стремительный взлёт, или резкое падение — самоконтроль и дисциплина помогут сохранить баланс. Усиливается интуиция, повышается сексуальность и общая энергия в теле. Проявляется гениальность, перфекционизм. Лучше воздержаться от поспешных решений. Благоприятно уделять время духовным практикам, рекомендуется йога.\nВ минусе проявляется ожидание похвалы и признания, повышенный эгоизм, хаос в голове и туман в мыслях, забывчивость, непонимание ситуации. Может появляться иллюзия, что всё чудесным образом разрешится само собой. Усиливается стремление к одиночеству. Возможны психологические срывы, уход «во все тяжкие».\nЛичный месяц 8. Месяц труда и обучения.\nЖелание много трудиться, внимание даже к мелочам. Адекватная оценка материальных событий и действий в жизни. Усиливается стремление всё контролировать. Проявляется мудрость, интуиция в денежных вопросах и событиях. Важно трудиться, учиться, повышать навыки и квалификацию, уделять внимание здоровью, меньше бездельничать. Посвятите себя достижению целей — терпение и упорство обязательно принесут результат.\nВ минусе проявляется чрезмерный контроль и недоверие, постоянные мысли о деньгах и возможные потери. Желание вершить правосудие или наказывать. Склонность к одиночеству и отшельничеству. Духовность может сменяться материализмом. Появляется тунеядство, стремление подмять всё под себя. Усиливается желание ничего не делать, но при этом много получать. Нежелательно подписывать кредитные договоры.\nЛичный месяц 9. Месяц служения и разрушения.\nМного энергии и желание побеждать. Усиливается целеустремлённость, благородство, спортивность и динамичность как образ жизни. Появляется стремление помогать и служить людям. Этот месяц хорошо посвятить бескорыстному служению другим, выделив часть своего ресурса на благо общества. Благоприятно заняться здоровьем — выявить слабые зоны и работать над их укреплением. В жизнь приходит освобождение от всего ненужного.\nВ минусе проявляется победа любой ценой, наивность и авантюризм. Возможны экстремальные и необдуманные действия в поисках адреналина. Склонность к апатии, бездействию и безразличию. Желание давить и навязывать своё мнение, проявления ярости и агрессии. Разрушение иллюзий (часто через болезненные ситуации) — важно принимать это с благодарностью. Возможны болезни, травмы, физические повреждения. Может уйти из жизни что-то дорогое или значимое, к чему вы были привязаны.\nЛичные дни описания:\nЛичный день 1. День новых начинаний.\nЛюбое начинание сегодня будет благоприятным и получит поддержку энергии дня. Человек может ощущать любовь и тепло в области сердечной чакры. Может также проявляться энергия деспотизма и эгоизма.  Человек становится менее терпеливым, не хочет идти на компромиссы. Важно сохранять внутреннее спокойствие, осознанность и направлять энергию в конструктивное русло — на выстраивание стратегии и реализацию задуманного плана.\nЛичный день 2. День понимания и дипломатии.\nПроявляйте терпение и понимание. Если вас не понимают — дайте пространство, слушайте искренне и без осуждения. Свяжитесь с кем-то важным: позвоните тем, с кем давно не общались. Это поможет восстановить ценные связи. Будьте особенно аккуратны в отношениях. Может появиться желание разорвать их, но задача дня — налаживать и укреплять. В минусе — день сомнений и возможного упадка настроения, депрессия. Обратите внимание на воду: контрастный душ, ванна или прогулка у воды обновят энергию и снимут напряжение. Проживайте день через дипломатию и мягкость.\nЛичный день 3. День анализа и планирования.\nАнализируйте каждое действие. Планируйте события — сегодня энергия анализа помогает принимать верные решения. Благоприятный день для медицинских процедур, операций и визита к врачу. Может возникнуть желание получить лёгкую выгоду через азартные действия. Действуйте через холодный анализ — иначе возможны потери.\nЛичный день 4. День мистических событий.\nДень мистических событий — как положительных, так и отрицательных. Может появляться чувство неудовлетворенности, поэтому важно сохранять позитивный настрой, чтобы были положительные мистические события. Иначе могут быть мистические потери. Посвятите день своим целям и мечтам. Визуализируйте желаемое, позволяйте себе мечтать без ограничений — именно это сегодня даст мощный импульс.\nЛичный день 5. День общения и открытых возможностей.\nХороший день, чтобы заводить новые знакомства, общаться, заниматься бизнесом, делиться мыслями и выкладывать посты в социальных сетях. Активное общение принесёт новые возможности, успех, карьерный рост и материальные блага. Всё тайное становится явным — могут открыться тайны и секреты. Может проявляться беспечность. Главное — не вступать в борьбу и сопротивление, а говорить «да» и соглашаться. Тогда энергия возможностей не будет блокироваться.\nЛичный день 6. День любви и успеха.\nРаботает энергия любви и счастья. Проявляйте творчество и любовь, ищите креативный подход даже в простых делах. Дарите заботу, говорите близким тёплые слова, проявляйте тактильность и внимание. Старайтесь создавать комфорт для других. В минусе может проявляться стремление к лени, мстительности и заботе только о собственном комфорте.\nЛичный день 7. День кризиса или осознанной трансформации.\nНачните утро с дисциплины тела: ходьбы, разминки, молитвы, медитации или йоги. В этот день полезно размышлять над «Формулой Успеха». Принимайте все события спокойно — как опыт, необходимый для роста и развития сознания. Не рекомендуется проводить операции, продавать недвижимость или делать инвестиции.\nЛичный день 8. День обучения и труда.\nНеобходимо много учиться и работать: полученные навыки будут служить всю жизнь и принесут финансовый результат. Избегайте чрезмерного отдыха и пустого времяпрепровождения — это снижает энергию дня. В минусе можно попасть в состояние ограничений: сомнения, недоверие, желание всё контролировать. Кредиты и финансовые обязательства сегодня брать не рекомендуется.\nЛичный день 9. День здоровья и благодарности.\nУделите внимание телу: полезны массаж, баня или оздоровительные процедуры. Спокойно отпускайте всё, чему пришло время уйти из вашей жизни. Энергия дня может быть немного воинственной, поэтому важно не вестись на эмоции и сохранять состояние покоя. В этом равновесии откроются новые возможности. Благоприятно заниматься благотворительностью, выражать благодарность, просить прощение, отдавать долги и служить людям."}}''')
PERSONAL_MONTH = json.loads(r'''{"2": {"short": "Личный месяц 2. Месяц дипломатии и выстраивания отношений.", "full": "Появляется больше реалистичности и стремления докопаться до сути. Активизируется энергия воспоминаний, усиливается чувственность. Во всём важно проявлять дипломатию. Серьёзные решения лучше отложить до следующего месяца. Полезно пить больше воды.\nМожет проявляться медлительность, сомнения, усиление депрессивных состояний. Мысли и действия часто направлены на разрыв отношений. Усиливается желание манипулировать."}, "1": {"short": "Личный месяц 1. Хороший месяц для начала дел.", "full": "В этом месяце важно посвятить себя стратегии и планированию. Благоприятный период для проявления лидерских качеств, повышения оптимизма и идеализма. Усиливаются качества оратора и психическая энергия влияния на людей. Хорошее время для начала новых проектов и стремления быть первым везде и во всём. Рекомендуется развивать личную ответственность и укреплять внутреннюю дисциплину.\nВ минусе проявляется сильный эгоизм, деспотизм и жажда подавления других. Возможны ошибочные и необдуманные действия. Могут проявиться такие качества, как самодурство, упрямство и твердолобие. В поступках может присутствовать авантюризм."}, "3": {"short": "Личный месяц 3. Месяц анализа и успеха.", "full": "Действовать через анализ: сначала думать, потом делать. Усиливается стремление к справедливости и заботе. Возникает желание учиться — это хороший период для экзаменов и медицинских процедур. Благоприятно структурировать дела и планы, анализировать каждый день и действовать по плану. Месяц особенно удачен для свадьбы.\nВ минусе проявляется лень, азарт и необдуманные шаги могут привести к потерям и разрушениям. Возможны упрямство, категоричность, чрезмерный контроль, требовательность, пустословие и нежелание учиться."}, "4": {"short": "Личный месяц 4. Месяц мистических событий, как положительных, так и отрицательных.", "full": "Посвятить месяц работе с целями. Важно всё упорядочить, структурировать, детализировать и четко спланировать. Будут появляться новые идеи и задачи. Усилится креатив, захочется новизны. Интуиция станет острее. Возможны неожиданные позитивные события и подарки судьбы.\nВ минусе проявляется апатия, желание разрушить то, что уже создано, в надежде на лучшее. Могут происходить отрицательные события мистического характера. Усилится стремление нарушать систему, правила и инструкции. В голове могут возникать мошеннические схемы. Появляется чувство неудовлетворенности и иллюзия, что с вами поступили нечестно."}, "5": {"short": "Личный месяц 5. Месяц коммуникаций и перемен.", "full": "Усиливается фарт и везение. Ум работает на рационализаторство и улучшения, логика становится сильнее. Растёт чувство эстетики, стиля и красоты. Легко подстраиваться под собеседника. Усиливается желание начать новый бизнес или проект. Благоприятно посвятить месяц разработке идей, дизайну, упаковке. Приходит энергия расширения и приумножения. Тянет к поездкам, путешествиям, шопингу, захочется что-то увеличить и развить.\nВ минусе проявляется повышенная обидчивость и ранимость. Может отключиться везение, усиливаться чувство паники и страха. События будут ограничивать свободу. Логика постоянно будет подвергаться ударам: люди ведут себя нелогично и неправильно. По отношению к другим возможны холодность, расчётливость, жёсткость, а местами даже жестокость. Возможно, личные тайны станут публичными или вскроется то, чего вы не знали. Участятся споры и несогласия, появится желание всё делать только с пользой для себя."}, "6": {"short": "Личный месяц 6. Месяц любви и успеха.", "full": "Период творчества и удачи. Возникает сильное желание действовать творчески, начать творческий проект или заняться искусством. Это время удачи, везения, богатства. Усиливается интуиция на деньги. Проявляется мудрость в мыслях и действиях. Повышается чувственность, тактильность и общительность. Важно всё делать с любовью и через творчество. Благоприятный период для бракосочетания, инвестиций, вложений и крупных покупок.\nВ минусе проявляется высокая эмоциональность, нежелание учиться, стремление к комфорту и излишествам. Может возникнуть соблазн заработать нечестным путём. Появляются мстительные сценарии в мыслях. Возможны болезни и обострения хронических заболеваний."}, "7": {"short": "Личный месяц 7. Месяц кризиса или осознанной трансформации.", "full": "Важно жить в дисциплине, тщательно продумывать все свои действия и мысли до конца. В этот период нет золотой середины: или стремительный взлёт, или резкое падение — самоконтроль и дисциплина помогут сохранить баланс. Усиливается интуиция, повышается сексуальность и общая энергия в теле. Проявляется гениальность, перфекционизм. Лучше воздержаться от поспешных решений. Благоприятно уделять время духовным практикам, рекомендуется йога.\nВ минусе проявляется ожидание похвалы и признания, повышенный эгоизм, хаос в голове и туман в мыслях, забывчивость, непонимание ситуации. Может появляться иллюзия, что всё чудесным образом разрешится само собой. Усиливается стремление к одиночеству. Возможны психологические срывы, уход «во все тяжкие»."}, "8": {"short": "Личный месяц 8. Месяц труда и обучения.", "full": "Желание много трудиться, внимание даже к мелочам. Адекватная оценка материальных событий и действий в жизни. Усиливается стремление всё контролировать. Проявляется мудрость, интуиция в денежных вопросах и событиях. Важно трудиться, учиться, повышать навыки и квалификацию, уделять внимание здоровью, меньше бездельничать. Посвятите себя достижению целей — терпение и упорство обязательно принесут результат.\nВ минусе проявляется чрезмерный контроль и недоверие, постоянные мысли о деньгах и возможные потери. Желание вершить правосудие или наказывать. Склонность к одиночеству и отшельничеству. Духовность может сменяться материализмом. Появляется тунеядство, стремление подмять всё под себя. Усиливается желание ничего не делать, но при этом много получать. Нежелательно подписывать кредитные договоры."}, "9": {"short": "Личный месяц 9. Месяц служения и разрушения.", "full": "Много энергии и желание побеждать. Усиливается целеустремлённость, благородство, спортивность и динамичность как образ жизни. Появляется стремление помогать и служить людям. Этот месяц хорошо посвятить бескорыстному служению другим, выделив часть своего ресурса на благо общества. Благоприятно заняться здоровьем — выявить слабые зоны и работать над их укреплением. В жизнь приходит освобождение от всего ненужного.\nВ минусе проявляется победа любой ценой, наивность и авантюризм. Возможны экстремальные и необдуманные действия в поисках адреналина. Склонность к апатии, бездействию и безразличию. Желание давить и навязывать своё мнение, проявления ярости и агрессии. Разрушение иллюзий (часто через болезненные ситуации) — важно принимать это с благодарностью. Возможны болезни, травмы, физические повреждения. Может уйти из жизни что-то дорогое или значимое, к чему вы были привязаны.\nЛичные дни описания:\nЛичный день 1. День новых начинаний.\nЛюбое начинание сегодня будет благоприятным и получит поддержку энергии дня. Человек может ощущать любовь и тепло в области сердечной чакры. Может также проявляться энергия деспотизма и эгоизма.  Человек становится менее терпеливым, не хочет идти на компромиссы. Важно сохранять внутреннее спокойствие, осознанность и направлять энергию в конструктивное русло — на выстраивание стратегии и реализацию задуманного плана.\nЛичный день 2. День понимания и дипломатии.\nПроявляйте терпение и понимание. Если вас не понимают — дайте пространство, слушайте искренне и без осуждения. Свяжитесь с кем-то важным: позвоните тем, с кем давно не общались. Это поможет восстановить ценные связи. Будьте особенно аккуратны в отношениях. Может появиться желание разорвать их, но задача дня — налаживать и укреплять. В минусе — день сомнений и возможного упадка настроения, депрессия. Обратите внимание на воду: контрастный душ, ванна или прогулка у воды обновят энергию и снимут напряжение. Проживайте день через дипломатию и мягкость.\nЛичный день 3. День анализа и планирования.\nАнализируйте каждое действие. Планируйте события — сегодня энергия анализа помогает принимать верные решения. Благоприятный день для медицинских процедур, операций и визита к врачу. Может возникнуть желание получить лёгкую выгоду через азартные действия. Действуйте через холодный анализ — иначе возможны потери.\nЛичный день 4. День мистических событий.\nДень мистических событий — как положительных, так и отрицательных. Может появляться чувство неудовлетворенности, поэтому важно сохранять позитивный настрой, чтобы были положительные мистические события. Иначе могут быть мистические потери. Посвятите день своим целям и мечтам. Визуализируйте желаемое, позволяйте себе мечтать без ограничений — именно это сегодня даст мощный импульс.\nЛичный день 5. День общения и открытых возможностей.\nХороший день, чтобы заводить новые знакомства, общаться, заниматься бизнесом, делиться мыслями и выкладывать посты в социальных сетях. Активное общение принесёт новые возможности, успех, карьерный рост и материальные блага. Всё тайное становится явным — могут открыться тайны и секреты. Может проявляться беспечность. Главное — не вступать в борьбу и сопротивление, а говорить «да» и соглашаться. Тогда энергия возможностей не будет блокироваться.\nЛичный день 6. День любви и успеха.\nРаботает энергия любви и счастья. Проявляйте творчество и любовь, ищите креативный подход даже в простых делах. Дарите заботу, говорите близким тёплые слова, проявляйте тактильность и внимание. Старайтесь создавать комфорт для других. В минусе может проявляться стремление к лени, мстительности и заботе только о собственном комфорте.\nЛичный день 7. День кризиса или осознанной трансформации.\nНачните утро с дисциплины тела: ходьбы, разминки, молитвы, медитации или йоги. В этот день полезно размышлять над «Формулой Успеха». Принимайте все события спокойно — как опыт, необходимый для роста и развития сознания. Не рекомендуется проводить операции, продавать недвижимость или делать инвестиции.\nЛичный день 8. День обучения и труда.\nНеобходимо много учиться и работать: полученные навыки будут служить всю жизнь и принесут финансовый результат. Избегайте чрезмерного отдыха и пустого времяпрепровождения — это снижает энергию дня. В минусе можно попасть в состояние ограничений: сомнения, недоверие, желание всё контролировать. Кредиты и финансовые обязательства сегодня брать не рекомендуется.\nЛичный день 9. День здоровья и благодарности.\nУделите внимание телу: полезны массаж, баня или оздоровительные процедуры. Спокойно отпускайте всё, чему пришло время уйти из вашей жизни. Энергия дня может быть немного воинственной, поэтому важно не вестись на эмоции и сохранять состояние покоя. В этом равновесии откроются новые возможности. Благоприятно заниматься благотворительностью, выражать благодарность, просить прощение, отдавать долги и служить людям."}}''')
PERSONAL_DAY = json.loads(r'''{"4": {"short": "Личный день 4. День мистических событий.", "full": "День мистических событий — как положительных, так и отрицательных. Может появляться чувство неудовлетворенности, поэтому важно сохранять позитивный настрой, чтобы были положительные мистические события. Иначе могут быть мистические потери. Посвятите день своим целям и мечтам. Визуализируйте желаемое, позволяйте себе мечтать без ограничений — именно это сегодня даст мощный импульс."}, "5": {"short": "Личный день 5. День общения и открытых возможностей.", "full": "Хороший день, чтобы заводить новые знакомства, общаться, заниматься бизнесом, делиться мыслями и выкладывать посты в социальных сетях. Активное общение принесёт новые возможности, успех, карьерный рост и материальные блага. Всё тайное становится явным — могут открыться тайны и секреты. Может проявляться беспечность. Главное — не вступать в борьбу и сопротивление, а говорить «да» и соглашаться. Тогда энергия возможностей не будет блокироваться."}, "1": {"short": "Личный день 1. День новых начинаний.", "full": "Любое начинание сегодня будет благоприятным и получит поддержку энергии дня. Человек может ощущать любовь и тепло в области сердечной чакры. Может также проявляться энергия деспотизма и эгоизма.  Человек становится менее терпеливым, не хочет идти на компромиссы. Важно сохранять внутреннее спокойствие, осознанность и направлять энергию в конструктивное русло — на выстраивание стратегии и реализацию задуманного плана."}, "2": {"short": "Личный день 2. День понимания и дипломатии.", "full": "Проявляйте терпение и понимание. Если вас не понимают — дайте пространство, слушайте искренне и без осуждения. Свяжитесь с кем-то важным: позвоните тем, с кем давно не общались. Это поможет восстановить ценные связи. Будьте особенно аккуратны в отношениях. Может появиться желание разорвать их, но задача дня — налаживать и укреплять. В минусе — день сомнений и возможного упадка настроения, депрессия. Обратите внимание на воду: контрастный душ, ванна или прогулка у воды обновят энергию и снимут напряжение. Проживайте день через дипломатию и мягкость."}, "3": {"short": "Личный день 3. День анализа и планирования.", "full": "Анализируйте каждое действие. Планируйте события — сегодня энергия анализа помогает принимать верные решения. Благоприятный день для медицинских процедур, операций и визита к врачу. Может возникнуть желание получить лёгкую выгоду через азартные действия. Действуйте через холодный анализ — иначе возможны потери."}, "6": {"short": "Личный день 6. День любви и успеха.", "full": "Работает энергия любви и счастья. Проявляйте творчество и любовь, ищите креативный подход даже в простых делах. Дарите заботу, говорите близким тёплые слова, проявляйте тактильность и внимание. Старайтесь создавать комфорт для других. В минусе может проявляться стремление к лени, мстительности и заботе только о собственном комфорте."}, "7": {"short": "Личный день 7. День кризиса или осознанной трансформации.", "full": "Начните утро с дисциплины тела: ходьбы, разминки, молитвы, медитации или йоги. В этот день полезно размышлять над «Формулой Успеха». Принимайте все события спокойно — как опыт, необходимый для роста и развития сознания. Не рекомендуется проводить операции, продавать недвижимость или делать инвестиции."}, "8": {"short": "Личный день 8. День обучения и труда.", "full": "Необходимо много учиться и работать: полученные навыки будут служить всю жизнь и принесут финансовый результат. Избегайте чрезмерного отдыха и пустого времяпрепровождения — это снижает энергию дня. В минусе можно попасть в состояние ограничений: сомнения, недоверие, желание всё контролировать. Кредиты и финансовые обязательства сегодня брать не рекомендуется."}, "9": {"short": "Личный день 9. День здоровья и благодарности.", "full": "Уделите внимание телу: полезны массаж, баня или оздоровительные процедуры. Спокойно отпускайте всё, чему пришло время уйти из вашей жизни. Энергия дня может быть немного воинственной, поэтому важно не вестись на эмоции и сохранять состояние покоя. В этом равновесии откроются новые возможности. Благоприятно заниматься благотворительностью, выражать благодарность, просить прощение, отдавать долги и служить людям."}}''')
GENERAL_DAY_SPECIAL = json.loads(r'''{"3": "Благоприятный день через анализ, успех. Хороший день для принятия серьезных решений, подписания договоров и совершения покупок.", "6": "Благоприятный день через любовь, успех. Хороший день для принятия решений, для подписания договоров. Делайте покупки, начинайте большие проекты."}''')

def _int_keys(d: dict) -> dict:
    out = {}
    for k, v in d.items():
        try:
            out[int(k)] = v
        except Exception:
            out[k] = v
    return out

PERSONAL_YEAR = _int_keys(PERSONAL_YEAR)
PERSONAL_MONTH = _int_keys(PERSONAL_MONTH)
PERSONAL_DAY = _int_keys(PERSONAL_DAY)
GENERAL_DAY_SPECIAL = _int_keys(GENERAL_DAY_SPECIAL)

GENERAL_DAY_FALLBACK = {
    1: "День перезапуска и обнуления. Лучше не начинать крупные новые проекты, не спешить с решениями.",
    2: "День баланса и дипломатии. Важно действовать мягко, договариваться, избегать конфликтов.",
    3: "День анализа и успеха. Подходит для решений, договоров и покупок.",
    4: "День дисциплины и структуры. Хорошо наводить порядок, планировать, закрывать хвосты.",
    5: "День общения и возможностей. Полезны встречи, переговоры, новые контакты.",
    6: "День любви и успеха. Хорошо укреплять отношения, делать крупные шаги и покупки.",
    7: "День глубины и тишины. Полезно учиться, анализировать, фокусироваться.",
    8: "День ресурсов и денег. Подходит для работы, финансовых вопросов, управления.",
    9: "День завершений и благодарности. Хорошо подводить итоги, отпускать лишнее, заботиться о здоровье.",
}

UNFAVORABLE_TEXT = (
    "Сегодня нежелательно начинать новые проекты и события. "
    "Есть высокая вероятность обнуления всех результатов ваших действий. "
    "Рекомендуется отложить на другой день крупные покупки, договоры, кредиты и т.д."
)

# ---------------- Utils ----------------
def now_tz() -> datetime:
    return datetime.now(TZ)

def ym_str(d: date) -> str:
    return f"{d.year:04d}-{d.month:02d}"

def to_single_digit(n: int) -> int:
    while n > 9:
        n = sum(int(c) for c in str(n))
    return 9 if n == 0 else n

def parse_birth_date(s: str) -> Optional[date]:
    s = (s or "").strip()
    try:
        return datetime.strptime(s, "%d.%m.%Y").date()
    except Exception:
        return None

def calc_general_day(today: date) -> int:
    return to_single_digit(sum(int(c) for c in today.strftime("%d%m%Y")))

def calc_personal_year(birth: date, today: date) -> int:
    ds = sum(int(c) for c in birth.strftime("%d%m")) + sum(int(c) for c in today.strftime("%Y"))
    return to_single_digit(ds)

def calc_personal_month(personal_year: int, today: date) -> int:
    ds = personal_year + sum(int(c) for c in today.strftime("%m"))
    return to_single_digit(ds)

def calc_personal_day(personal_month: int, today: date) -> int:
    ds = personal_month + sum(int(c) for c in today.strftime("%d"))
    return to_single_digit(ds)

def get_general_day_text(od: int, today: date) -> str:
    if today.day in (10, 20, 30):
        return f"Сегодня Общий день: {od}. {UNFAVORABLE_TEXT}"
    if od in GENERAL_DAY_SPECIAL:
        return f"Сегодня Общий день: {od}. {GENERAL_DAY_SPECIAL[od]}"
    return f"Сегодня Общий день: {od}. {GENERAL_DAY_FALLBACK.get(od,'')}"

def get_desc(section: Dict[int, Dict[str, str]], n: int, full: bool) -> str:
    item = section.get(n, {})
    if full:
        txt = (item.get("full") or "").strip()
        if txt:
            return txt
    return (item.get("short") or "").strip()

# ---------------- Google Sheets ----------------
_gs_ok = False
_gs_client = None
_subs_ws = None
_gs_last_fail_at: Optional[datetime] = None

def _safe_preview(raw: str) -> str:
    raw = (raw or "").strip()
    if not raw:
        return "EMPTY"
    return f"len={len(raw)} head={raw[:12]!r}"

def _load_sa_info() -> dict:
    raw = (os.getenv("GOOGLE_SA_JSON") or "").strip()
    if raw:
        return json.loads(raw)
    b64 = (os.getenv("GOOGLE_SA_JSON_B64") or "").strip()
    if b64:
        decoded = base64.b64decode(b64).decode("utf-8").strip()
        return json.loads(decoded)
    raise ValueError("No GOOGLE_SA_JSON or GOOGLE_SA_JSON_B64 provided")

def gs_init_safe() -> bool:
    global _gs_ok, _gs_client, _subs_ws, _gs_last_fail_at
    if _gs_ok:
        return True
    if not GSHEET_ID:
        log.warning("Google Sheets disabled: GSHEET_ID not set")
        return False
    if gspread is None or Credentials is None:
        log.warning("Google Sheets disabled: gspread/google-auth not installed")
        return False
    now_dt = now_tz()
    if _gs_last_fail_at and (now_dt - _gs_last_fail_at).total_seconds() < 60:
        return False
    try:
        log.info("ENV CHECK: GSHEET_ID=%s SUBS_SHEET_NAME=%r GOOGLE_SA_JSON=%s GOOGLE_SA_JSON_B64=%s",
                 GSHEET_ID[:6] + "...",
                 SUBS_SHEET_NAME,
                 _safe_preview(os.getenv("GOOGLE_SA_JSON")),
                 _safe_preview(os.getenv("GOOGLE_SA_JSON_B64")))
        sa_info = _load_sa_info()
        scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
        creds = Credentials.from_service_account_info(sa_info, scopes=scopes)
        _gs_client = gspread.authorize(creds)
        sh = _gs_client.open_by_key(GSHEET_ID)
        _subs_ws = sh.worksheet(SUBS_SHEET_NAME)
        header = _subs_ws.row_values(1)
        if header != SUBS_COLUMNS:
            _subs_ws.resize(rows=max(_subs_ws.row_count, 2), cols=len(SUBS_COLUMNS))
            _subs_ws.update("A1", [SUBS_COLUMNS])
        _gs_ok = True
        log.info("Google Sheets connected OK: spreadsheet=%r worksheet=%r", sh.title, SUBS_SHEET_NAME)
        return True
    except Exception as e:
        _gs_last_fail_at = now_dt
        log.warning("Google Sheets not ready: %s", e)
        return False

def ws():
    return _subs_ws if gs_init_safe() else None

def find_user_row(ws, uid: int) -> Optional[int]:
    col = ws.col_values(1)
    s = str(uid)
    for i, v in enumerate(col, start=1):
        if v.strip() == s:
            return i
    return None

def row_dict(ws, row_idx: int) -> Dict[str, str]:
    vals = ws.row_values(row_idx)
    vals += [""] * (len(SUBS_COLUMNS) - len(vals))
    return {SUBS_COLUMNS[i]: vals[i] for i in range(len(SUBS_COLUMNS))}

def update_row(ws, row_idx: int, data: Dict[str, Any]) -> None:
    row = row_dict(ws, row_idx)
    for k, v in data.items():
        if k in row:
            row[k] = "" if v is None else str(v)
    ws.update(f"A{row_idx}", [[row[c] for c in SUBS_COLUMNS]])

def append_user(ws, data: Dict[str, Any]) -> None:
    row = ["" for _ in SUBS_COLUMNS]
    for i, c in enumerate(SUBS_COLUMNS):
        if c in data and data[c] is not None:
            row[i] = str(data[c])
    ws.append_row(row, value_input_option="USER_ENTERED")

# fallback store if sheets are down (non-persistent)
_fallback: Dict[int, Dict[str, Any]] = {}

# --- Admin ---
def _parse_admin_ids() -> set[int]:
    raw = (os.getenv("ADMIN_IDS") or "").strip()
    out: set[int] = set()
    for part in raw.replace(";", ",").split(","):
        part = part.strip()
        if not part:
            continue
        try:
            out.add(int(part))
        except Exception:
            pass
    return out

ADMIN_IDS = _parse_admin_ids()

def is_admin(update: Update) -> bool:
    uid = int(update.effective_user.id) if update.effective_user else 0
    return bool(uid and uid in ADMIN_IDS)

def main_keyboard() -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton("📅 Сегодня"), KeyboardButton("👤 Профиль")],
            [KeyboardButton("💳 Подписка"), KeyboardButton("ℹ️ Помощь")],
        ],
        resize_keyboard=True,
    )

def admin_keyboard() -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton("📊 Статистика"), KeyboardButton("📣 Рассылка")],
            [KeyboardButton("🔎 Юзер"), KeyboardButton("⬅️ Меню")],
        ],
        resize_keyboard=True,
    )

def get_user_by_id(uid: int) -> Optional[Dict[str, Any]]:
    _ws = ws()
    if _ws is None:
        return _fallback.get(uid)
    row_idx = find_user_row(_ws, uid)
    if row_idx is None:
        return None
    return row_dict(_ws, row_idx)

def count_users() -> Dict[str, int]:
    """Best-effort stats from sheet. If sheets are down, uses fallback."""
    _ws = ws()
    if _ws is None:
        total = len(_fallback)
        blocked = sum(1 for u in _fallback.values() if (u.get("status") or "").lower() == "blocked")
        premium = sum(1 for u in _fallback.values() if (u.get("plan") or "").lower() == "premium")
        trial = sum(1 for u in _fallback.values() if (u.get("plan") or "").lower() == "trial")
        return {"total": total, "blocked": blocked, "premium": premium, "trial": trial}
    try:
        rows = _ws.get_all_values()
        if not rows:
            return {"total": 0, "blocked": 0, "premium": 0, "trial": 0}
        header = rows[0]
        idx_status = header.index("status")
        idx_plan = header.index("plan")
        total = 0
        blocked = premium = trial = 0
        for r in rows[1:]:
            if not any(x.strip() for x in r):
                continue
            total += 1
            status = (r[idx_status].strip().lower() if idx_status < len(r) else "")
            plan = (r[idx_plan].strip().lower() if idx_plan < len(r) else "")
            if status == "blocked":
                blocked += 1
            if plan == "premium":
                premium += 1
            if plan == "trial":
                trial += 1
        return {"total": total, "blocked": blocked, "premium": premium, "trial": trial}
    except Exception:
        return {"total": 0, "blocked": 0, "premium": 0, "trial": 0}

def get_or_create_user(update: Update) -> Dict[str, Any]:
    user = update.effective_user
    uid = int(user.id)
    now_dt = now_tz()
    today = now_dt.date()

    _ws = ws()
    if _ws is None:
        u = _fallback.get(uid)
        if not u:
            u = {
                "telegram_user_id": uid,
                "status": "active",
                "plan": "trial",
                "trial_expires": (today + timedelta(days=3)).isoformat(),
                "birth_date": "",
                "created_at": now_dt.isoformat(timespec="seconds"),
                "last_seen_at": now_dt.isoformat(timespec="seconds"),
                "username": user.username or "",
                "first_name": user.first_name or "",
                "last_name": user.last_name or "",
                "registered_on": today.isoformat(),
                "last_full_ym": "",
            }
            _fallback[uid] = u
        else:
            u["last_seen_at"] = now_dt.isoformat(timespec="seconds")
        return u

    row_idx = find_user_row(_ws, uid)
    if row_idx is None:
        data = {
            "telegram_user_id": uid,
            "status": "active",
            "plan": "trial",
            "trial_expires": (today + timedelta(days=3)).isoformat(),
            "birth_date": "",
            "created_at": now_dt.isoformat(timespec="seconds"),
            "last_seen_at": now_dt.isoformat(timespec="seconds"),
            "username": user.username or "",
            "first_name": user.first_name or "",
            "last_name": user.last_name or "",
            "registered_on": today.isoformat(),
            "last_full_ym": "",
        }
        append_user(_ws, data)
        return data

    u = row_dict(_ws, row_idx)
    update_row(_ws, row_idx, {
        "last_seen_at": now_dt.isoformat(timespec="seconds"),
        "username": user.username or "",
        "first_name": user.first_name or "",
        "last_name": user.last_name or "",
    })
    u.update({
        "last_seen_at": now_dt.isoformat(timespec="seconds"),
        "username": user.username or "",
        "first_name": user.first_name or "",
        "last_name": user.last_name or "",
    })
    return u

def save_user(uid: int, data: Dict[str, Any]) -> None:
    _ws = ws()
    if _ws is None:
        if uid in _fallback:
            _fallback[uid].update(data)
        return
    row_idx = find_user_row(_ws, uid)
    if row_idx is None:
        return
    update_row(_ws, row_idx, data)

def date_from_iso(s: str) -> Optional[date]:
    try:
        return datetime.fromisoformat((s or "").strip()).date()
    except Exception:
        return None

def enforce_trial(u: Dict[str, Any], today: date) -> bool:
    # returns True if status changed to blocked
    if (u.get("plan") or "").lower() == "trial":
        exp = date_from_iso(u.get("trial_expires"))
        if exp and today > exp:
            u["status"] = "blocked"
            return True
    return False

def is_allowed(u: Dict[str, Any], today: date) -> bool:
    if (u.get("status") or "").lower() == "blocked":
        return False
    plan = (u.get("plan") or "").lower()
    if plan == "premium":
        return True
    if plan == "trial":
        exp = date_from_iso(u.get("trial_expires"))
        return exp is not None and today <= exp
    return False

def build_forecast(u: Dict[str, Any], today: date, full_ym: bool) -> str:
    birth = parse_birth_date(u.get("birth_date") or "")
    od = calc_general_day(today)

    lines = [f"📅 Дата: {today.strftime('%d.%m.%Y')}", "", f"🌐 {get_general_day_text(od, today)}", ""]
    if not birth:
        lines.append("Чтобы посчитать Личный год/месяц/день, пришли дату рождения в формате ДД.ММ.ГГГГ.")
        return "\n".join(lines)

    ly = calc_personal_year(birth, today)
    lm = calc_personal_month(ly, today)
    ld = calc_personal_day(lm, today)

    if full_ym:
        lines.append(f"🗓 Личный год: {ly}")
        lines.append(get_desc(PERSONAL_YEAR, ly, full=True))
        lines.append("")
        lines.append(f"🗓 Личный месяц: {lm}")
        lines.append(get_desc(PERSONAL_MONTH, lm, full=True))
        lines.append("")
    else:
        lines.append(f"🗓 {get_desc(PERSONAL_YEAR, ly, full=False)}")
        lines.append(f"🗓 {get_desc(PERSONAL_MONTH, lm, full=False)}")
        lines.append("")

    lines.append(f"🔢 Личный день: {ld}")
    lines.append(get_desc(PERSONAL_DAY, ld, full=True))
    return "\n".join(lines).strip()

ASK_BIRTH = 1

MAIN_KB = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton("📅 Сегодня"), KeyboardButton("👤 Профиль")],
        [KeyboardButton("💳 Подписка"), KeyboardButton("ℹ️ Помощь")],
    ],
    resize_keyboard=True,
)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    u = get_or_create_user(update)
    uid = int(update.effective_user.id)
    today = now_tz().date()

    if enforce_trial(u, today):
        save_user(uid, {"status": "blocked"})
    if not is_allowed(u, today):
        await update.message.reply_text(
            "⛔️ Доступ ограничен.\nTrial закончился или доступ отключён.\nОбратитесь к администратору.",
            reply_markup=MAIN_KB,
        )
        return ConversationHandler.END

    # notify admins about new user if possible
    if ADMIN_IDS:
        try:
            created_at = (u.get("created_at") or "")
            if created_at.startswith(today.isoformat()):
                txt = (
                    "🆕 Новый пользователь\n"
                    f"id: {uid}\n"
                    f"username: @{update.effective_user.username or '-'}\n"
                    f"name: {(update.effective_user.first_name or '')} {(update.effective_user.last_name or '')}"
                ).strip()
                for aid in ADMIN_IDS:
                    try:
                        await context.bot.send_message(chat_id=aid, text=txt)
                    except Exception:
                        pass
        except Exception:
            pass

    if not (u.get("birth_date") or "").strip():
        await update.message.reply_text("Привет! Пришли дату рождения в формате ДД.ММ.ГГГГ (например 05.03.1994).")
        return ASK_BIRTH

    await today_cmd(update, context)
    return ConversationHandler.END

async def set_birth(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    uid = int(update.effective_user.id)
    d = parse_birth_date(update.message.text)
    if not d:
        await update.message.reply_text("Неверный формат. Введи дату рождения как ДД.ММ.ГГГГ, например 05.03.1994.")
        return ASK_BIRTH
    save_user(uid, {"birth_date": d.strftime("%d.%m.%Y")})
    await update.message.reply_text("✅ Дата рождения сохранена.")
    await today_cmd(update, context)
    return ConversationHandler.END

async def today_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    u = get_or_create_user(update)
    uid = int(update.effective_user.id)
    today = now_tz().date()

    if enforce_trial(u, today):
        save_user(uid, {"status": "blocked"})
    if not is_allowed(u, today):
        await update.message.reply_text("⛔️ Доступ ограничен.\nTrial закончился или доступ отключён.\nОбратитесь к администратору.")
        return

    cur_ym = ym_str(today)
    last_full_ym = (u.get("last_full_ym") or "").strip()
    full_ym = (today.day == 1) or (last_full_ym != cur_ym)

    msg = build_forecast(u, today=today, full_ym=full_ym)

    if full_ym and parse_birth_date(u.get("birth_date") or ""):
        save_user(uid, {"last_full_ym": cur_ym})

    plan = (u.get("plan") or "").lower()
    if plan in ("premium", "trial"):
        msg += "\n\n⭐️ Premium активен: полный прогноз доступен + ежедневка 09:00."

    await update.message.reply_text(msg)

async def me(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    u = get_or_create_user(update)
    await update.message.reply_text(
        "Ваш профиль:\n"
        f"id: {u.get('telegram_user_id')}\n"
        f"status: {u.get('status')}\n"
        f"plan: {u.get('plan')}\n"
        f"trial_expires: {u.get('trial_expires')}\n"
        f"birth_date: {u.get('birth_date') or '-'}\n"
        f"last_full_ym: {u.get('last_full_ym') or '-'}"
    , reply_markup=MAIN_KB)


async def subscribe_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    u = get_or_create_user(update)
    today = now_tz().date()
    if not is_allowed(u, today):
        await update.message.reply_text("⛔️ Доступ ограничен. Обратитесь к администратору.", reply_markup=MAIN_KB)
        return
    plan = (u.get("plan") or "free").lower()
    trial_expires = u.get("trial_expires") or "-"
    await update.message.reply_text(
        "Подписка:\n"
        f"• plan: {plan}\n"
        f"• trial_expires: {trial_expires}\n\n"
        "Если нужен Premium — напишите администратору.",
        reply_markup=MAIN_KB,
    )


async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(
        "Кнопки/команды:\n"
        "• 📅 Сегодня (/today) — прогноз на сегодня\n"
        "• 👤 Профиль (/me) — ваш статус/план/дата рождения\n"
        "• 💳 Подписка (/subscribe) — информация по подписке\n\n"
        "Можно просто отправить дату рождения в формате ДД.ММ.ГГГГ — прогноз придёт сразу.",
        reply_markup=MAIN_KB,
    )


async def menu_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handles reply-keyboard button presses."""
    if not update.message:
        return
    txt = (update.message.text or "").strip()
    if txt == "📅 Сегодня":
        await today_cmd(update, context)
    elif txt == "👤 Профиль":
        await me(update, context)
    elif txt == "💳 Подписка":
        await subscribe_cmd(update, context)
    elif txt == "ℹ️ Помощь":
        await help_cmd(update, context)


async def birth_anytime(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """If user sends a birth date (DD.MM.YYYY) anywhere, save and immediately send forecast."""
    if not update.message:
        return
    raw = (update.message.text or "").strip()
    if not raw:
        return
    # Ignore if looks like a command or one of the menu buttons
    if raw.startswith("/") or raw in {"📅 Сегодня", "👤 Профиль", "💳 Подписка", "ℹ️ Помощь"}:
        return
    bd = parse_birth_date(raw)
    if not bd:
        return

    u = get_or_create_user(update)
    u["birth_date"] = bd.isoformat()
    u["registered_on"] = u.get("registered_on") or now_tz().date().isoformat()
    u["last_seen_at"] = now_tz().isoformat(timespec="seconds")
    save_user(u)

    # Send forecast immediately
    await update.message.reply_text(
        f"✅ Дата рождения сохранена: {bd.strftime('%d.%m.%Y')}\n\n" + build_forecast(u),
        reply_markup=MAIN_KB,
    )


# ---------------- Admin ----------------
def _is_admin(update: Update) -> bool:
    uid = update.effective_user.id if update.effective_user else None
    return uid in ADMIN_IDS


async def admin_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not _is_admin(update):
        await update.message.reply_text("⛔️ Нет доступа.", reply_markup=MAIN_KB)
        return
    await update.message.reply_text(
        "Админ-команды:\n"
        "• /admin_stats — статистика\n"
        "• /admin_user <telegram_user_id> — профиль юзера\n"
        "• /admin_setplan <id> <free|premium> — сменить план\n"
        "• /admin_trial <id> <days> — продлить trial\n"
        "• /admin_broadcast <текст> — рассылка всем (кроме blocked)\n",
        reply_markup=MAIN_KB,
    )


async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not _is_admin(update):
        await update.message.reply_text("⛔️ Нет доступа.", reply_markup=MAIN_KB)
        return
    _ws = ws()
    if _ws is None:
        await update.message.reply_text("Google Sheets не готовы.", reply_markup=MAIN_KB)
        return

    rows = _ws.get_all_records(expected_headers=COLUMNS)
    total = len(rows)
    by_status = {}
    by_plan = {}
    for r in rows:
        by_status[r.get("status") or "-"] = by_status.get(r.get("status") or "-", 0) + 1
        by_plan[r.get("plan") or "-"] = by_plan.get(r.get("plan") or "-", 0) + 1
    await update.message.reply_text(
        "📊 Статистика:\n"
        f"• Всего: {total}\n"
        f"• По статусам: {by_status}\n"
        f"• По планам: {by_plan}",
        reply_markup=MAIN_KB,
    )


async def admin_user(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not _is_admin(update):
        await update.message.reply_text("⛔️ Нет доступа.", reply_markup=MAIN_KB)
        return
    if not context.args or not context.args[0].isdigit():
        await update.message.reply_text("Использование: /admin_user <telegram_user_id>", reply_markup=MAIN_KB)
        return
    uid = int(context.args[0])
    _ws = ws()
    if _ws is None:
        await update.message.reply_text("Google Sheets не готовы.", reply_markup=MAIN_KB)
        return
    row_idx = find_user_row(_ws, uid)
    if row_idx is None:
        await update.message.reply_text("Не найден.", reply_markup=MAIN_KB)
        return
    u = row_dict(_ws, row_idx)
    await update.message.reply_text(
        "👤 User:\n"
        f"id: {u.get('telegram_user_id')}\n"
        f"status: {u.get('status')}\n"
        f"plan: {u.get('plan')}\n"
        f"trial_expires: {u.get('trial_expires')}\n"
        f"birth_date: {u.get('birth_date')}\n"
        f"created_at: {u.get('created_at')}\n"
        f"last_seen_at: {u.get('last_seen_at')}\n"
        f"username: {u.get('username')}\n"
        f"first_name: {u.get('first_name')}\n"
        f"last_name: {u.get('last_name')}\n"
        f"registered_on: {u.get('registered_on')}\n"
        f"last_full_ym: {u.get('last_full_ym')}",
        reply_markup=MAIN_KB,
    )


async def admin_setplan(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not _is_admin(update):
        await update.message.reply_text("⛔️ Нет доступа.", reply_markup=MAIN_KB)
        return
    if len(context.args) < 2 or not context.args[0].isdigit():
        await update.message.reply_text("Использование: /admin_setplan <id> <free|premium>", reply_markup=MAIN_KB)
        return
    uid = int(context.args[0])
    plan = context.args[1].lower().strip()
    if plan not in {"free", "premium"}:
        await update.message.reply_text("plan должен быть free или premium", reply_markup=MAIN_KB)
        return
    _ws = ws()
    if _ws is None:
        await update.message.reply_text("Google Sheets не готовы.", reply_markup=MAIN_KB)
        return
    row_idx = find_user_row(_ws, uid)
    if row_idx is None:
        await update.message.reply_text("Не найден.", reply_markup=MAIN_KB)
        return
    update_row(_ws, row_idx, {"plan": plan})
    await update.message.reply_text(f"✅ plan обновлён: {uid} -> {plan}", reply_markup=MAIN_KB)


async def admin_trial(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not _is_admin(update):
        await update.message.reply_text("⛔️ Нет доступа.", reply_markup=MAIN_KB)
        return
    if len(context.args) < 2 or not context.args[0].isdigit() or not context.args[1].isdigit():
        await update.message.reply_text("Использование: /admin_trial <id> <days>", reply_markup=MAIN_KB)
        return
    uid = int(context.args[0])
    days = int(context.args[1])
    days = max(1, min(days, 365))
    _ws = ws()
    if _ws is None:
        await update.message.reply_text("Google Sheets не готовы.", reply_markup=MAIN_KB)
        return
    row_idx = find_user_row(_ws, uid)
    if row_idx is None:
        await update.message.reply_text("Не найден.", reply_markup=MAIN_KB)
        return
    cur = row_dict(_ws, row_idx)
    base = parse_date(cur.get("trial_expires") or "") or now_tz().date()
    new = base + dt.timedelta(days=days)
    update_row(_ws, row_idx, {"trial_expires": new.isoformat(), "status": "active"})
    await update.message.reply_text(f"✅ trial продлён до {new.isoformat()} для {uid}", reply_markup=MAIN_KB)


async def admin_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not _is_admin(update):
        await update.message.reply_text("⛔️ Нет доступа.", reply_markup=MAIN_KB)
        return
    text = (" ".join(context.args) or "").strip()
    if not text:
        await update.message.reply_text("Использование: /admin_broadcast <текст>", reply_markup=MAIN_KB)
        return
    _ws = ws()
    if _ws is None:
        await update.message.reply_text("Google Sheets не готовы.", reply_markup=MAIN_KB)
        return
    ids = _ws.col_values(1)[1:]
    sent = 0
    for s in ids:
        s = (s or "").strip()
        if not s.isdigit():
            continue
        uid = int(s)
        row_idx = find_user_row(_ws, uid)
        if row_idx is None:
            continue
        u = row_dict(_ws, row_idx)
        if (u.get("status") or "").lower() == "blocked":
            continue
        try:
            await context.bot.send_message(chat_id=uid, text=text)
            sent += 1
        except Exception:
            continue
    await update.message.reply_text(f"✅ Рассылка отправлена: {sent}", reply_markup=MAIN_KB)

# ---------------- Daily broadcast ----------------
async def daily_broadcast(context: ContextTypes.DEFAULT_TYPE) -> None:
    today = now_tz().date()
    _ws = ws()
    if _ws is None:
        log.warning("Daily broadcast skipped: Google Sheets not ready")
        return

    ids = _ws.col_values(1)[1:]
    for s in ids:
        s = (s or "").strip()
        if not s.isdigit():
            continue
        uid = int(s)
        row_idx = find_user_row(_ws, uid)
        if row_idx is None:
            continue
        u = row_dict(_ws, row_idx)

        if enforce_trial(u, today):
            update_row(_ws, row_idx, {"status": "blocked"})
            continue
        if not is_allowed(u, today):
            continue

        cur_ym = ym_str(today)
        last_full_ym = (u.get("last_full_ym") or "").strip()
        full_ym = (today.day == 1) or (last_full_ym != cur_ym)

        msg = build_forecast(u, today=today, full_ym=full_ym)
        if full_ym and parse_birth_date(u.get("birth_date") or ""):
            update_row(_ws, row_idx, {"last_full_ym": cur_ym})

        try:
            await context.bot.send_message(chat_id=uid, text=msg)
        except Exception:
            continue

# ---------------- Error handler ----------------
async def on_error(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    err = context.error
    if isinstance(err, Conflict):
        log.error("Polling conflict (409): another getUpdates is running with same token. Exiting.")
        try:
            await context.application.stop()
            await context.application.shutdown()
        finally:
            os._exit(0)
    log.error("Unhandled error: %s", err, exc_info=err)

def schedule_jobs(app: Application) -> None:
    if app.job_queue is None:
        log.warning('No JobQueue set up. Install: pip install "python-telegram-bot[job-queue]"')
        return
    app.job_queue.run_daily(daily_broadcast, time=time(9, 0, tzinfo=TZ), name="daily_broadcast")
    log.info("Daily broadcast scheduled at 09:00")

def build_app() -> Application:
    app = Application.builder().token(TOKEN).build()

    conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={ASK_BIRTH: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_birth)]},
        fallbacks=[],
        allow_reentry=True,
    )

    app.add_handler(conv)
    app.add_handler(CommandHandler("today", today_cmd))
    app.add_handler(CommandHandler("me", me))
    app.add_handler(CommandHandler("subscribe", subscribe_cmd))
    app.add_handler(CommandHandler("help", help_cmd))

    # Admin
    app.add_handler(CommandHandler("admin", admin_menu))
    app.add_handler(CommandHandler("admin_stats", admin_stats))
    app.add_handler(CommandHandler("admin_user", admin_user))
    app.add_handler(CommandHandler("admin_set_plan", admin_set_plan))
    app.add_handler(CommandHandler("admin_grant_trial", admin_grant_trial))
    app.add_handler(CommandHandler("admin_broadcast", admin_broadcast))

    # Any-time birth date (DD.MM.YYYY) -> save + forecast immediately
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND & filters.Regex(r"^\s*\d{2}\.\d{2}\.\d{4}\s*$"), birth_anytime))

    # Buttons
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, buttons_handler))
    app.add_error_handler(on_error)
    return app

def main() -> None:
    log.info(
        "BOOT ENV: TOKEN_set=%s GSHEET_ID_set=%s GOOGLE_SA_JSON_len=%d GOOGLE_SA_JSON_B64_len=%d",
        bool(TOKEN),
        bool(GSHEET_ID),
        len((os.getenv("GOOGLE_SA_JSON") or "").strip()),
        len((os.getenv("GOOGLE_SA_JSON_B64") or "").strip()),
    )

    # Non-fatal init
    gs_init_safe()

    app = build_app()
    schedule_jobs(app)

    # --- Webhook on Render Web Service ---
    # Set one of:
    #   RENDER_EXTERNAL_URL=https://<service>.onrender.com
    #   WEBHOOK_BASE_URL=https://<service>.onrender.com
    # Or turn off webhooks:
    #   BOT_MODE=polling
    mode = (os.getenv("BOT_MODE") or "webhook").strip().lower()
    if mode == "polling":
        log.info("Bot started in polling mode")
        app.run_polling(drop_pending_updates=True)
        return

    base_url = (os.getenv("RENDER_EXTERNAL_URL") or os.getenv("WEBHOOK_BASE_URL") or "").strip().rstrip("/")
    if not base_url:
        log.warning("WEBHOOK disabled: missing RENDER_EXTERNAL_URL/WEBHOOK_BASE_URL -> falling back to polling")
        app.run_polling(drop_pending_updates=True)
        return

    port = int(os.getenv("PORT") or "10000")
    secret = (os.getenv("WEBHOOK_SECRET") or "").strip() or secrets.token_hex(16)
    path = f"telegram/webhook/{secret}"
    webhook_url = f"{base_url}/{path}"
    log.info("Webhook server 0.0.0.0:%s path=/%s => %s", port, path, webhook_url)

    app.run_webhook(
        listen="0.0.0.0",
        port=port,
        url_path=path,
        webhook_url=webhook_url,
        drop_pending_updates=True,
    )

if __name__ == "__main__":
    main()
